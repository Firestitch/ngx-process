{"version":3,"file":"write-bundles.transform.js","sourceRoot":"","sources":["../../../../src/lib/ng-package/entry-point/write-bundles.transform.ts"],"names":[],"mappings":";;;AAAA,2BAA2B;AAC3B,qDAA6D;AAE7D,oCAAgF;AAChF,qEAAsE;AACtE,iDAAwD;AAGjD,MAAM,qBAAqB,GAAG,CAAC,OAAyB,EAAE,EAAE,CAAC,gCAAoB,CAAC,KAAK,EAAC,KAAK,EAAC,EAAE;IACrG,MAAM,UAAU,GAAmB,KAAK,CAAC,IAAI,CAAC,8BAAsB,EAAE,CAAC,CAAC;IACxE,MAAM,EAAE,gBAAgB,EAAE,UAAU,EAAE,YAAY,EAAE,QAAQ,EAAE,GAAG,UAAU,CAAC,IAAI,CAAC;IACjF,MAAM,KAAK,GAAG,UAAU,CAAC,KAAK,CAAC;IAE/B,sCAAsC;IACtC,MAAM,gBAAgB,GAAG,UAAU;SAChC,MAAM,CAAC,oBAAY,CAAC;SACpB,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC;SAC7B,MAAM,CAAC,CAAC,IAAI,EAAE,EAAgB,EAAE,EAAE;QACjC,IAAI,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC;QAE7B,OAAO,IAAI,CAAC;IACd,CAAC,EAAE,EAAE,CAAC,CAAC;IAET,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,GAAG,EAAE,GAAG,gBAAgB,CAAC;IAEpD,MAAM,IAAI,GAAG;QACX,UAAU,EAAE,QAAQ,CAAC,OAAO,CAAC,UAAU;QACvC,GAAG,EAAE,EAAE,EAAE,EAAE,YAAY,CAAC,KAAK,EAAE;QAC/B,YAAY,EAAE;YACZ,GAAG,YAAY,CAAC,YAAY;YAC5B,GAAG,gBAAgB;SACpB;QACD,KAAK,EAAE,OAAO;KACf,CAAC;IAEF,MAAM,OAAO,GAAG,GAAG,CAAC;QAClB,UAAU,EAAE,KAAK;QACjB,YAAY,EAAE,KAAK;KACpB,CAAC,CAAC;IAEH,IAAI;QACF,OAAO,CAAC,KAAK,CAAC,sBAAsB,CAAC,CAAC;QACtC,MAAM,eAAe,GAAG,MAAM,yBAAgB,CAAC;YAC7C,GAAG,IAAI;YACP,UAAU,EAAE,YAAY,CAAC,QAAQ;YACjC,MAAM,EAAE,IAAI;YACZ,IAAI,EAAE,QAAQ;YACd,KAAK,EAAE,KAAK,CAAC,eAAe;SAC7B,CAAC,CAAC;QACH,OAAO,CAAC,OAAO,EAAE,CAAC;QAElB,IAAI,OAAO,CAAC,KAAK,EAAE;YACjB,KAAK,CAAC,eAAe,GAAG,eAAe,CAAC;YAExC,OAAO;SACR;QAED,OAAO,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;QACjC,MAAM,yBAAgB,CAAC;YACrB,GAAG,IAAI;YACP,UAAU,EAAE,YAAY,CAAC,KAAK;YAC9B,KAAK,EAAE,OAAO;YACd,MAAM,EAAE,KAAK;YACb,IAAI,EAAE,GAAG;YACT,SAAS,EAAE,uCAAoB;SAChC,CAAC,CAAC;QACH,OAAO,CAAC,OAAO,EAAE,CAAC;KACnB;IAAC,OAAO,KAAK,EAAE;QACd,OAAO,CAAC,IAAI,EAAE,CAAC;QACf,MAAM,KAAK,CAAC;KACb;AACH,CAAC,CAAC,CAAC;AA/DU,QAAA,qBAAqB,yBA+D/B","sourcesContent":["import * as ora from 'ora';\nimport { transformFromPromise } from '../../graph/transform';\nimport { NgEntryPoint } from './entry-point';\nimport { isEntryPoint, isEntryPointInProgress, EntryPointNode } from '../nodes';\nimport { downlevelCodeWithTsc } from '../../flatten/downlevel-plugin';\nimport { rollupBundleFile } from '../../flatten/rollup';\nimport { NgPackagrOptions } from '../options.di';\n\nexport const writeBundlesTransform = (options: NgPackagrOptions) => transformFromPromise(async graph => {\n  const entryPoint: EntryPointNode = graph.find(isEntryPointInProgress());\n  const { destinationFiles, entryPoint: ngEntryPoint, tsConfig } = entryPoint.data;\n  const cache = entryPoint.cache;\n\n  // Add UMD module IDs for dependencies\n  const dependencyUmdIds = entryPoint\n    .filter(isEntryPoint)\n    .map(ep => ep.data.entryPoint)\n    .reduce((prev, ep: NgEntryPoint) => {\n      prev[ep.moduleId] = ep.umdId;\n\n      return prev;\n    }, {});\n\n  const { fesm2015, esm2015, umd } = destinationFiles;\n\n  const opts = {\n    sourceRoot: tsConfig.options.sourceRoot,\n    amd: { id: ngEntryPoint.amdId },\n    umdModuleIds: {\n      ...ngEntryPoint.umdModuleIds,\n      ...dependencyUmdIds,\n    },\n    entry: esm2015,\n  };\n\n  const spinner = ora({\n    hideCursor: false,\n    discardStdin: false,\n  });\n\n  try {\n    spinner.start('Bundling to FESM2015');\n    const rollupFESMCache = await rollupBundleFile({\n      ...opts,\n      moduleName: ngEntryPoint.moduleId,\n      format: 'es',\n      dest: fesm2015,\n      cache: cache.rollupFESMCache,\n    });\n    spinner.succeed();\n\n    if (options.watch) {\n      cache.rollupFESMCache = rollupFESMCache;\n\n      return;\n    }\n\n    spinner.start('Bundling to UMD');\n    await rollupBundleFile({\n      ...opts,\n      moduleName: ngEntryPoint.umdId,\n      entry: esm2015,\n      format: 'umd',\n      dest: umd,\n      transform: downlevelCodeWithTsc,\n    });\n    spinner.succeed();\n  } catch (error) {\n    spinner.fail();\n    throw error;\n  }\n});\n"]}