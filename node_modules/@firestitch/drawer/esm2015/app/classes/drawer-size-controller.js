import { Injectable, NgZone } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, filter, takeUntil } from 'rxjs/operators';
import { DrawerRef } from '../classes/drawer-ref';
import { FsDrawerPersistanceController } from './persistance-controller';
import { DrawerStoreService } from '../services/drawer-store.service';
import { MAIN_DRAWER_DEFAULT_WIDTH, MAIN_RESIZE_ACTION_BAR_WIDTH, SIDE_DRAWER_DEFAULT_WIDTH, SIDE_RESIZE_BAR_WIDTH } from '../consts/sizes.cont';
import * as i0 from "@angular/core";
import * as i1 from "../classes/drawer-ref";
import * as i2 from "./persistance-controller";
import * as i3 from "../services/drawer-store.service";
export class DrawerSizeController {
    constructor(_drawerRef, _ngZone, _persistanceController, _drawerStore) {
        this._drawerRef = _drawerRef;
        this._ngZone = _ngZone;
        this._persistanceController = _persistanceController;
        this._drawerStore = _drawerStore;
        this._sideOpened = false;
        this._borderPadding = 0;
        this._destroy$ = new Subject();
    }
    get mainElRef() {
        return this._mainElRef;
    }
    get sideElRef() {
        return this._sideElRef;
    }
    get mainConfig() {
        return this._mainConfig;
    }
    get sideConfig() {
        return this._sideConfig;
    }
    get screenWidth() {
        return this._screenWidth;
    }
    get persistedMainWidth() {
        return this._persistanceController.enabled
            ? this._persistanceController.getDataFromScope('mainWidth')
            : null;
    }
    get persistedSideWidth() {
        return this._persistanceController.enabled
            ? this._persistanceController.getDataFromScope('sideWidth')
            : null;
    }
    init() {
        this._initDefaultConfigs();
        this._updateScreenWidth();
        this._listenWindowResize();
        this._listenSideToggle();
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
    registerElRef(el) {
        if (el.isMainDrawer) {
            this._registerMainRef(el);
            this._listenWidthChanges(el);
        }
        else if (el.isSideDrawer) {
            this._registerSideRef(el);
            this._listenWidthChanges(el);
        }
        else {
            throw Error('Unrecognized resize element type');
        }
    }
    removeElRef(el) {
        if (el.isMainDrawer) {
            this._removeMainRef();
        }
        else if (el.isSideDrawer) {
            this._removeSideRef();
        }
    }
    getInitialWidth(type) {
        if (type === 'main') {
            return this.mainConfig.initial;
        }
        else if (type === 'side') {
            return this.sideConfig.initial;
        }
        else {
            return void 0;
        }
    }
    getMinWidth(type) {
        var _a, _b;
        if (type === 'main') {
            return (_a = this.mainConfig.min) !== null && _a !== void 0 ? _a : 0;
        }
        else if (type === 'side') {
            return (_b = this.sideConfig.min) !== null && _b !== void 0 ? _b : 0;
        }
        else {
            return 0;
        }
    }
    getMaxWidth(type) {
        var _a, _b;
        if (type === 'main') {
            return (_a = this.mainConfig.max) !== null && _a !== void 0 ? _a : window.innerWidth;
        }
        else if (type === 'side') {
            return (_b = this.sideConfig.max) !== null && _b !== void 0 ? _b : window.innerWidth;
        }
        else {
            return window.innerWidth;
        }
    }
    /**
     * Update width from outside with all calculations to be done
     * @param width
     */
    updateMainWidth(width) {
        const sideWidth = (this.sideElRef && this.sideElRef.width) || 0;
        this.mainElRef.updateWidth(sideWidth + width);
    }
    /**
     * Update width from outside with all calculations to be done
     * @param width
     */
    updateSideWidth(width) {
        if (this.sideElRef) {
            const currentWidth = this.mainElRef.width - this.sideElRef.width;
            this.mainElRef.updateWidth(currentWidth + width);
            this.sideElRef.updateWidth(width);
        }
    }
    /**
     * Push current drawer to be visible under new one opened
     * @param inFrontDrawer
     */
    pushMainWidth(inFrontDrawer) {
        const inFrontDrawerTotalWidth = inFrontDrawer.resizeController.mainElRef.width
            + MAIN_RESIZE_ACTION_BAR_WIDTH;
        if (this.mainElRef.width <= inFrontDrawerTotalWidth) {
            this.updateMainWidth(inFrontDrawerTotalWidth);
        }
    }
    /**
     * Listen for browser resize and update restrictions
     */
    _listenWindowResize() {
        this._ngZone.runOutsideAngular(() => {
            fromEvent(window, 'resize')
                .pipe(debounceTime(50), takeUntil(this._destroy$))
                .subscribe(() => {
                this._updateScreenWidth();
                this._updateMinMaxStyles();
            });
        });
    }
    /**
     * Copy initial configs or set default values
     */
    _initDefaultConfigs() {
        // Main initialization
        this._mainConfig =
            (this._drawerRef.drawerConfig.width && this._drawerRef.drawerConfig.width.main)
                || {};
        this._mainConfig.initial = this.persistedMainWidth
            || this._mainConfig.initial
            || MAIN_DRAWER_DEFAULT_WIDTH;
        // Side initialization
        this._sideConfig =
            (this._drawerRef.drawerConfig.width && this._drawerRef.drawerConfig.width.side)
                || {};
        this._sideConfig.initial = this.persistedSideWidth
            || this._sideConfig.initial
            || SIDE_DRAWER_DEFAULT_WIDTH;
    }
    _registerMainRef(el) {
        this._mainElRef = el;
    }
    _registerSideRef(el) {
        this._sideElRef = el;
    }
    _removeMainRef() {
        this._mainElRef = null;
    }
    _removeSideRef() {
        this._sideElRef = null;
    }
    /**
     * Update current window size
     */
    _updateScreenWidth() {
        this._screenWidth = (window.innerWidth - this._borderPadding);
    }
    /**
     * Update min&max css props for containers
     */
    _updateMinMaxStyles() {
        this.mainElRef.setMinMaxStyles();
        if (this.sideElRef) {
            this.sideElRef.setMinMaxStyles();
        }
    }
    _listenSideToggle() {
        this._drawerRef.sideToggle$
            .pipe(takeUntil(this._destroy$))
            .subscribe((opened) => {
            if (this._sideOpened === opened) {
                return;
            }
            this._sideOpened = opened;
            if (opened) {
                const currentWidth = this.mainElRef.width;
                const sideWidth = this.getInitialWidth('side');
                this._mainElRef.updateWidth(currentWidth + sideWidth + SIDE_RESIZE_BAR_WIDTH);
            }
            else {
                const actualSideWidth = this.sideElRef.fsDrawerResizer.getBoundingClientRect().width;
                const mainWidth = this.mainElRef.width - actualSideWidth - SIDE_RESIZE_BAR_WIDTH;
                this._mainElRef.updateWidth(mainWidth);
            }
        });
    }
    _listenWidthChanges(el) {
        if (!this._persistanceController.enabled) {
            return;
        }
        el.width$
            .pipe(debounceTime(200), filter(() => {
            return this._drawerStore.getLevelForRef(el.drawerRef) === this._drawerStore.numberOfOpenedDrawers;
        }))
            .subscribe({
            next: () => {
                var _a;
                const sideWidth = ((_a = this._sideElRef) === null || _a === void 0 ? void 0 : _a.width) || 0;
                if (this._mainElRef) {
                    this._persistanceController.saveDataToScope('mainWidth', this._mainElRef.width - sideWidth - SIDE_RESIZE_BAR_WIDTH);
                }
                if (this._sideElRef) {
                    this._persistanceController.saveDataToScope('sideWidth', sideWidth);
                }
            }
        });
    }
}
DrawerSizeController.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: DrawerSizeController, deps: [{ token: i1.DrawerRef }, { token: i0.NgZone }, { token: i2.FsDrawerPersistanceController }, { token: i3.DrawerStoreService }], target: i0.ɵɵFactoryTarget.Injectable });
DrawerSizeController.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: DrawerSizeController });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: DrawerSizeController, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.DrawerRef }, { type: i0.NgZone }, { type: i2.FsDrawerPersistanceController }, { type: i3.DrawerStoreService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd2VyLXNpemUtY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcHAvY2xhc3Nlcy9kcmF3ZXItc2l6ZS1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBRTlELE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWpFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUdsRCxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLDRCQUE0QixFQUM1Qix5QkFBeUIsRUFBRSxxQkFBcUIsRUFDakQsTUFBTSxzQkFBc0IsQ0FBQzs7Ozs7QUFJOUIsTUFBTSxPQUFPLG9CQUFvQjtJQWUvQixZQUNVLFVBQTBCLEVBQzFCLE9BQWUsRUFDZixzQkFBcUQsRUFDckQsWUFBZ0M7UUFIaEMsZUFBVSxHQUFWLFVBQVUsQ0FBZ0I7UUFDMUIsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNmLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBK0I7UUFDckQsaUJBQVksR0FBWixZQUFZLENBQW9CO1FBWGxDLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBR1gsbUJBQWMsR0FBRyxDQUFDLENBQUM7UUFFNUIsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFPckMsQ0FBQztJQUVKLElBQVcsU0FBUztRQUNsQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDekIsQ0FBQztJQUVELElBQVcsU0FBUztR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QztpQkFDSDtZQUNILENBQUM7U0FDRixDQUFDLENBQUE7SUFDTixDQUFDOztrSEExUlUsb0JBQW9CO3NIQUFwQixvQkFBb0I7NEZBQXBCLG9CQUFvQjtrQkFEaEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGZyb21FdmVudCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBmaWx0ZXIsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgRHJhd2VyUmVmIH0gZnJvbSAnLi4vY2xhc3Nlcy9kcmF3ZXItcmVmJztcbmltcG9ydCB7IEZzRHJhd2VyUmVzaXplckRpcmVjdGl2ZSB9IGZyb20gJy4uL2RpcmVjdGl2ZXMvZHJhd2VyLXJlc2l6ZXIuZGlyZWN0aXZlJztcbmltcG9ydCB7IElEcmF3ZXJXaWR0aERlZmluaXRpb24gfSBmcm9tICcuLi9pbnRlcmZhY2VzL2RyYXdlci1jb25maWcuaW50ZXJmYWNlJztcbmltcG9ydCB7IEZzRHJhd2VyUGVyc2lzdGFuY2VDb250cm9sbGVyIH0gZnJvbSAnLi9wZXJzaXN0YW5jZS1jb250cm9sbGVyJztcbmltcG9ydCB7IERyYXdlclN0b3JlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2RyYXdlci1zdG9yZS5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE1BSU5fRFJBV0VSX0RFRkFVTFRfV0lEVEgsXG4gIE1BSU5fUkVTSVpFX0FDVElPTl9CQVJfV0lEVEgsXG4gIFNJREVfRFJBV0VSX0RFRkFVTFRfV0lEVEgsIFNJREVfUkVTSVpFX0JBUl9XSURUSFxufSBmcm9tICcuLi9jb25zdHMvc2l6ZXMuY29udCc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERyYXdlclNpemVDb250cm9sbGVyIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuICBwcml2YXRlIF9tYWluRWxSZWY6IEZzRHJhd2VyUmVzaXplckRpcmVjdGl2ZTtcbiAgcHJpdmF0ZSBfc2lkZUVsUmVmOiBGc0RyYXdlclJlc2l6ZXJEaXJlY3RpdmU7XG5cbiAgcHJpdmF0ZSBfbWFpbkNvbmZpZzogSURyYXdlcldpZHRoRGVmaW5pdGlvbjtcbiAgcHJpdmF0ZSBfc2lkZUNvbmZpZzogSURyYXdlcldpZHRoRGVmaW5pdGlvbjtcblxuICBwcml2YXRlIF9zaWRlT3BlbmVkID0gZmFsc2U7XG4gIHByaXZhdGUgX3NjcmVlbldpZHRoOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfYm9yZGVyUGFkZGluZyA9IDA7XG5cbiAgcHJpdmF0ZSBfZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX2RyYXdlclJlZjogRHJhd2VyUmVmPGFueT4sXG4gICAgcHJpdmF0ZSBfbmdab25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSBfcGVyc2lzdGFuY2VDb250cm9sbGVyOiBGc0RyYXdlclBlcnNpc3RhbmNlQ29udHJvbGxlcixcbiAgICBwcml2YXRlIF9kcmF3ZXJTdG9yZTogRHJhd2VyU3RvcmVTZXJ2aWNlLFxuICApIHt9XG5cbiAgcHVibGljIGdldCBtYWluRWxSZWYoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21haW5FbFJlZjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc2lkZUVsUmVmKCkge1xuICAgIHJldHVybiB0aGlzLl9zaWRlRWxSZWY7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1haW5Db25maWcoKTogSURyYXdlcldpZHRoRGVmaW5pdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuX21haW5Db25maWc7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHNpZGVDb25maWcoKTogSURyYXdlcldpZHRoRGVmaW5pdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuX3NpZGVDb25maWc7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHNjcmVlbldpZHRoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3NjcmVlbldpZHRoO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgcGVyc2lzdGVkTWFpbldpZHRoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5lbmFibGVkXG4gICAgICA/IHRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5nZXREYXRhRnJvbVNjb3BlKCdtYWluV2lkdGgnKVxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgcGVyc2lzdGVkU2lkZVdpZHRoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5lbmFibGVkXG4gICAgICA/IHRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5nZXREYXRhRnJvbVNjb3BlKCdzaWRlV2lkdGgnKVxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgcHVibGljIGluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5faW5pdERlZmF1bHRDb25maWdzKCk7XG4gICAgdGhpcy5fdXBkYXRlU2NyZWVuV2lkdGgoKTtcbiAgICB0aGlzLl9saXN0ZW5XaW5kb3dSZXNpemUoKTtcbiAgICB0aGlzLl9saXN0ZW5TaWRlVG9nZ2xlKCk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fZGVzdHJveSQubmV4dCgpO1xuICAgIHRoaXMuX2Rlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJFbFJlZihlbDogRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlKSB7XG4gICAgaWYgKGVsLmlzTWFpbkRyYXdlcikge1xuICAgICAgdGhpcy5fcmVnaXN0ZXJNYWluUmVmKGVsKTtcbiAgICAgIHRoaXMuX2xpc3RlbldpZHRoQ2hhbmdlcyhlbCk7XG4gICAgfSBlbHNlIGlmIChlbC5pc1NpZGVEcmF3ZXIpIHtcbiAgICAgIHRoaXMuX3JlZ2lzdGVyU2lkZVJlZihlbCk7XG4gICAgICB0aGlzLl9saXN0ZW5XaWR0aENoYW5nZXMoZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBFcnJvcignVW5yZWNvZ25pemVkIHJlc2l6ZSBlbGVtZW50IHR5cGUnKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVFbFJlZihlbDogRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlKSB7XG4gICAgaWYgKGVsLmlzTWFpbkRyYXdlcikge1xuICAgICAgdGhpcy5fcmVtb3ZlTWFpblJlZigpO1xuICAgIH0gZWxzZSBpZiAoZWwuaXNTaWRlRHJhd2VyKSB7XG4gICAgICB0aGlzLl9yZW1vdmVTaWRlUmVmKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldEluaXRpYWxXaWR0aCh0eXBlOiAnbWFpbicgfCAnc2lkZScpOiBudW1iZXIge1xuICAgIGlmICh0eXBlID09PSAnbWFpbicpIHtcbiAgICAgIHJldHVybiB0aGlzLm1haW5Db25maWcuaW5pdGlhbDtcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzaWRlJykge1xuICAgICAgcmV0dXJuIHRoaXMuc2lkZUNvbmZpZy5pbml0aWFsO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNaW5XaWR0aCh0eXBlOiAnbWFpbicgfCAnc2lkZScpOiBudW1iZXIge1xuICAgIGlmICh0eXBlID09PSAnbWFpbicpIHtcbiAgICAgIHJldHVybiB0aGlzLm1haW5Db25maWcubWluID8/IDA7XG4gICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2lkZScpIHtcbiAgICAgIHJldHVybiB0aGlzLnNpZGVDb25maWcubWluID8/IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNYXhXaWR0aCh0eXBlOiAnbWFpbicgfCAnc2lkZScpOiBudW1iZXIge1xuICAgIGlmICh0eXBlID09PSAnbWFpbicpIHtcbiAgICAgIHJldHVybiB0aGlzLm1haW5Db25maWcubWF4ID8/IHdpbmRvdy5pbm5lcldpZHRoO1xuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3NpZGUnKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaWRlQ29uZmlnLm1heCA/PyB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHdpbmRvdy5pbm5lcldpZHRoO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgd2lkdGggZnJvbSBvdXRzaWRlIHdpdGggYWxsIGNhbGN1bGF0aW9ucyB0byBiZSBkb25lXG4gICAqIEBwYXJhbSB3aWR0aFxuICAgKi9cbiAgcHVibGljIHVwZGF0ZU1haW5XaWR0aCh3aWR0aDogbnVtYmVyKSB7XG4gICAgY29uc3Qgc2lkZVdpZHRoID0gKHRoaXMuc2lkZUVsUmVmICYmIHRoaXMuc2lkZUVsUmVmLndpZHRoKSB8fCAwO1xuICAgIHRoaXMubWFpbkVsUmVmLnVwZGF0ZVdpZHRoKHNpZGVXaWR0aCArIHdpZHRoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgd2lkdGggZnJvbSBvdXRzaWRlIHdpdGggYWxsIGNhbGN1bGF0aW9ucyB0byBiZSBkb25lXG4gICAqIEBwYXJhbSB3aWR0aFxuICAgKi9cbiAgcHVibGljIHVwZGF0ZVNpZGVXaWR0aCh3aWR0aDogbnVtYmVyKSB7XG4gICAgaWYgKHRoaXMuc2lkZUVsUmVmKSB7XG4gICAgICBjb25zdCBjdXJyZW50V2lkdGggPSB0aGlzLm1haW5FbFJlZi53aWR0aCAtIHRoaXMuc2lkZUVsUmVmLndpZHRoO1xuICAgICAgdGhpcy5tYWluRWxSZWYudXBkYXRlV2lkdGgoY3VycmVudFdpZHRoICsgd2lkdGgpO1xuICAgICAgdGhpcy5zaWRlRWxSZWYudXBkYXRlV2lkdGgod2lkdGgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQdXNoIGN1cnJlbnQgZHJhd2VyIHRvIGJlIHZpc2libGUgdW5kZXIgbmV3IG9uZSBvcGVuZWRcbiAgICogQHBhcmFtIGluRnJvbnREcmF3ZXJcbiAgICovXG4gIHB1YmxpYyBwdXNoTWFpbldpZHRoKGluRnJvbnREcmF3ZXI6IERyYXdlclJlZjxhbnk+KSB7XG4gICAgY29uc3QgaW5Gcm9udERyYXdlclRvdGFsV2lkdGggPSBpbkZyb250RHJhd2VyLnJlc2l6ZUNvbnRyb2xsZXIubWFpbkVsUmVmLndpZHRoXG4gICAgICArIE1BSU5fUkVTSVpFX0FDVElPTl9CQVJfV0lEVEg7XG5cbiAgICBpZiAodGhpcy5tYWluRWxSZWYud2lkdGggPD0gaW5Gcm9udERyYXdlclRvdGFsV2lkdGgpIHtcbiAgICAgIHRoaXMudXBkYXRlTWFpbldpZHRoKGluRnJvbnREcmF3ZXJUb3RhbFdpZHRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlzdGVuIGZvciBicm93c2VyIHJlc2l6ZSBhbmQgdXBkYXRlIHJlc3RyaWN0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBfbGlzdGVuV2luZG93UmVzaXplKCkge1xuICAgIHRoaXMuX25nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBmcm9tRXZlbnQod2luZG93LCAncmVzaXplJylcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgZGVib3VuY2VUaW1lKDUwKSxcbiAgICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjcmVlbldpZHRoKCk7XG4gICAgICAgICAgdGhpcy5fdXBkYXRlTWluTWF4U3R5bGVzKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvcHkgaW5pdGlhbCBjb25maWdzIG9yIHNldCBkZWZhdWx0IHZhbHVlc1xuICAgKi9cbiAgcHJpdmF0ZSBfaW5pdERlZmF1bHRDb25maWdzKCkge1xuICAgIC8vIE1haW4gaW5pdGlhbGl6YXRpb25cbiAgICB0aGlzLl9tYWluQ29uZmlnID1cbiAgICAgICh0aGlzLl9kcmF3ZXJSZWYuZHJhd2VyQ29uZmlnLndpZHRoICYmIHRoaXMuX2RyYXdlclJlZi5kcmF3ZXJDb25maWcud2lkdGgubWFpbilcbiAgICAgIHx8IHt9O1xuXG4gICAgdGhpcy5fbWFpbkNvbmZpZy5pbml0aWFsID0gdGhpcy5wZXJzaXN0ZWRNYWluV2lkdGhcbiAgICAgIHx8IHRoaXMuX21haW5Db25maWcuaW5pdGlhbFxuICAgICAgfHwgTUFJTl9EUkFXRVJfREVGQVVMVF9XSURUSDtcblxuXG4gICAgLy8gU2lkZSBpbml0aWFsaXphdGlvblxuICAgIHRoaXMuX3NpZGVDb25maWcgPVxuICAgICAgKHRoaXMuX2RyYXdlclJlZi5kcmF3ZXJDb25maWcud2lkdGggJiYgdGhpcy5fZHJhd2VyUmVmLmRyYXdlckNvbmZpZy53aWR0aC5zaWRlKVxuICAgICAgfHwge307XG5cbiAgICB0aGlzLl9zaWRlQ29uZmlnLmluaXRpYWwgPSB0aGlzLnBlcnNpc3RlZFNpZGVXaWR0aFxuICAgICAgfHwgdGhpcy5fc2lkZUNvbmZpZy5pbml0aWFsXG4gICAgICB8fCBTSURFX0RSQVdFUl9ERUZBVUxUX1dJRFRIO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVnaXN0ZXJNYWluUmVmKGVsOiBGc0RyYXdlclJlc2l6ZXJEaXJlY3RpdmUpIHtcbiAgICB0aGlzLl9tYWluRWxSZWYgPSBlbDtcbiAgfVxuXG4gIHByaXZhdGUgX3JlZ2lzdGVyU2lkZVJlZihlbDogRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlKSB7XG4gICAgdGhpcy5fc2lkZUVsUmVmID0gZWw7XG4gIH1cblxuICBwcml2YXRlIF9yZW1vdmVNYWluUmVmKCkge1xuICAgIHRoaXMuX21haW5FbFJlZiA9IG51bGw7XG4gIH1cblxuICBwcml2YXRlIF9yZW1vdmVTaWRlUmVmKCkge1xuICAgIHRoaXMuX3NpZGVFbFJlZiA9IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGN1cnJlbnQgd2luZG93IHNpemVcbiAgICovXG4gIHByaXZhdGUgX3VwZGF0ZVNjcmVlbldpZHRoKCk6IHZvaWQge1xuICAgIHRoaXMuX3NjcmVlbldpZHRoID0gKHdpbmRvdy5pbm5lcldpZHRoIC0gdGhpcy5fYm9yZGVyUGFkZGluZyk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIG1pbiZtYXggY3NzIHByb3BzIGZvciBjb250YWluZXJzXG4gICAqL1xuICBwcml2YXRlIF91cGRhdGVNaW5NYXhTdHlsZXMoKTogdm9pZCB7XG4gICAgdGhpcy5tYWluRWxSZWYuc2V0TWluTWF4U3R5bGVzKCk7XG5cbiAgICBpZiAodGhpcy5zaWRlRWxSZWYpIHtcbiAgICAgIHRoaXMuc2lkZUVsUmVmLnNldE1pbk1heFN0eWxlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2xpc3RlblNpZGVUb2dnbGUoKTogdm9pZCB7XG4gICAgdGhpcy5fZHJhd2VyUmVmLnNpZGVUb2dnbGUkXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKG9wZW5lZDogYm9vbGVhbikgPT4ge1xuICAgICAgICBpZiAodGhpcy5fc2lkZU9wZW5lZCA9PT0gb3BlbmVkKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc2lkZU9wZW5lZCA9IG9wZW5lZDtcblxuICAgICAgICBpZiAob3BlbmVkKSB7XG4gICAgICAgICAgY29uc3QgY3VycmVudFdpZHRoID0gdGhpcy5tYWluRWxSZWYud2lkdGg7XG4gICAgICAgICAgY29uc3Qgc2lkZVdpZHRoID0gdGhpcy5nZXRJbml0aWFsV2lkdGgoJ3NpZGUnKTtcblxuICAgICAgICAgIHRoaXMuX21haW5FbFJlZi51cGRhdGVXaWR0aChjdXJyZW50V2lkdGggKyBzaWRlV2lkdGggKyBTSURFX1JFU0laRV9CQVJfV0lEVEgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGFjdHVhbFNpZGVXaWR0aCA9IHRoaXMuc2lkZUVsUmVmLmZzRHJhd2VyUmVzaXplci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aDtcbiAgICAgICAgICBjb25zdCBtYWluV2lkdGggPSB0aGlzLm1haW5FbFJlZi53aWR0aCAtIGFjdHVhbFNpZGVXaWR0aCAtIFNJREVfUkVTSVpFX0JBUl9XSURUSDtcblxuICAgICAgICAgIHRoaXMuX21haW5FbFJlZi51cGRhdGVXaWR0aChtYWluV2lkdGgpO1xuICAgICAgICB9XG4gICAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBfbGlzdGVuV2lkdGhDaGFuZ2VzKGVsOiBGc0RyYXdlclJlc2l6ZXJEaXJlY3RpdmUpIHtcbiAgICBpZiAoIXRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5lbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZWwud2lkdGgkXG4gICAgICAucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDIwMCksXG4gICAgICAgIGZpbHRlcigoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2RyYXdlclN0b3JlLmdldExldmVsRm9yUmVmKGVsLmRyYXdlclJlZikgPT09IHRoaXMuX2RyYXdlclN0b3JlLm51bWJlck9mT3BlbmVkRHJhd2VycztcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHNpZGVXaWR0aCA9IHRoaXMuX3NpZGVFbFJlZj8ud2lkdGggfHwgMDtcblxuICAgICAgICAgIGlmICh0aGlzLl9tYWluRWxSZWYpIHtcbiAgICAgICAgICAgIHRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5zYXZlRGF0YVRvU2NvcGUoXG4gICAgICAgICAgICAgICdtYWluV2lkdGgnLFxuICAgICAgICAgICAgICB0aGlzLl9tYWluRWxSZWYud2lkdGggLSBzaWRlV2lkdGggLSBTSURFX1JFU0laRV9CQVJfV0lEVEgsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICh0aGlzLl9zaWRlRWxSZWYpIHtcbiAgICAgICAgICAgIHRoaXMuX3BlcnNpc3RhbmNlQ29udHJvbGxlci5zYXZlRGF0YVRvU2NvcGUoXG4gICAgICAgICAgICAgICdzaWRlV2lkdGgnLFxuICAgICAgICAgICAgICBzaWRlV2lkdGhcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG59XG4iXX0=