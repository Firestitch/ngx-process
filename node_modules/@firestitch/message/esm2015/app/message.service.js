import { Injectable, Inject } from '@angular/core';
import { MatDialog } from '@angular/material/dialog';
import { takeUntil } from 'rxjs/operators';
import { Subject, of } from 'rxjs';
import { ToastrService, TOAST_CONFIG } from 'ngx-toastr';
import { FsMessageDialogComponent } from './components/message-dialog/message-dialog.component';
import { MessageType, MessageMode } from './enums';
import { FS_MESSAGE_CONFIG } from './injectors/message-config';
import * as i0 from "@angular/core";
import * as i1 from "ngx-toastr";
import * as i2 from "@angular/material/dialog";
export class FsMessage {
    constructor(toastr, matDialog, _toastToken, _config) {
        this.toastr = toastr;
        this.matDialog = matDialog;
        this._toastToken = _toastToken;
        this._config = _config;
        this.bannerMessages$ = new Subject();
        this._dialogs = 0;
        this._dialogsMessagesQueue = [];
        this._destroy$ = new Subject();
    }
    success(message, options = {}) {
        return this.show(MessageType.Success, message, Object.assign({ title: 'Success', mode: this._config.successMode }, options));
    }
    info(message, options = {}) {
        return this.show(MessageType.Info, message, Object.assign({ title: 'Information', mode: this._config.infoMode }, options));
    }
    error(message, options = {}) {
        return this.show(MessageType.Error, message, Object.assign({ title: 'Attention', mode: this._config.errorMode }, options));
    }
    warning(message, options = {}) {
        return this.show(MessageType.Warning, message, Object.assign({ title: 'Warning', mode: this._config.warningMode }, options));
    }
    show(type, message, options) {
        options = options || {};
        if (options.icon === undefined) {
            options.icon = this.getIconName(type);
        }
        switch (options.mode) {
            case MessageMode.Toast:
                this.toast(type, message, options);
                break;
            case MessageMode.Banner:
                this.banner(type, message, options);
                break;
            case MessageMode.Dialog:
                return this.dialog(type, message, options);
        }
        return of();
    }
    hide() {
        this.toastr.clear();
        this.bannerMessages$.next();
        this.matDialog.closeAll();
    }
    toast(type, message, options) {
        const opts = options;
        opts.enableHtml = true;
        opts.positionClass = options.positionClass || this._toastToken.config.positionClass || 'toast-bottom-left';
        opts.timeOut = (options.timeout || this._config.toastTimeout) * 1000;
        const icon = opts.icon ? `<div class="mat-icon material-icons">${opts.icon}</div>` : '';
        const template = `<div class="mat-toast-content">${icon}<div class="message">${message}</div></div>`;
        this.toastr[type](template, '', opts);
    }
    banner(type, message, options) {
        this.bannerMessages$.next({
            type: type,
            msg: message,
            timeout: (options.timeout || this._config.bannerTimeout || 5) * 1000
        });
    }
    dialog(type, message, options) {
        const typeMessage = type + message;
        if (this._dialogsMessagesQueue.indexOf(typeMessage) > -1) {
            return of(true);
        }
        this._dialogsMessagesQueue.push(typeMessage);
        this._dialogs++;
        const dialogRef = this.matDialog.open(FsMessageDialogComponent, {
            /* Waiting for MatDialog to support array of classes like panelClass
            backdropClass: ['fs-message-backdrop',
                            'fs-message-backdrop-' + type,
                            options.backdropClass], */
            backdropClass: options.backdropClass,
            width: options.width || this._config.dialogWidth,
            data: { type: type, message: message, options: options, icon: this.getIconName(type) },
            panelClass: [
                'fs-message-pane',
                'fs-message-pane-' + type,
                options.panelClass,
            ],
        });
        dialogRef.afterClosed()
            .pipe(takeUntil(this._destroy$))
            .subscribe(() => {
            this._dialogs--;
            const dialogMessageIdx = this._dialogsMessagesQueue.indexOf(typeMessage);
            if (dialogMessageIdx > -1) {
                this._dialogsMessagesQueue.splice(dialogMessageIdx, 1);
            }
        });
        return dialogRef.afterClosed();
    }
    getIconName(type) {
        switch (type) {
            case MessageType.Success:
                return 'done';
            case MessageType.Error:
                return 'report_problem';
            case MessageType.Info:
                return 'info';
            case MessageType.Warning:
                return 'report_problem';
        }
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
}
FsMessage.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsMessage, deps: [{ token: i1.ToastrService }, { token: i2.MatDialog }, { token: TOAST_CONFIG }, { token: FS_MESSAGE_CONFIG }], target: i0.ɵɵFactoryTarget.Injectable });
FsMessage.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsMessage });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsMessage, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ToastrService }, { type: i2.MatDialog }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TOAST_CONFIG]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [FS_MESSAGE_CONFIG]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwcC9tZXNzYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFOUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXJELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQWMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBYyxNQUFNLFlBQVksQ0FBQztBQUVyRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxzREFBc0QsQ0FBQztBQUNoRyxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBaUIsTUFBTSxTQUFTLENBQUM7QUFDbEUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7Ozs7QUFRL0QsTUFBTSxPQUFPLFNBQVM7SUFRcEIsWUFDVSxNQUFxQixFQUNyQixTQUFvQixFQUNFLFdBQXVCLEVBQ2xCLE9BQXdCO1FBSG5ELFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNFLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQ2xCLFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBVnRELG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUUvQixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsMEJBQXFCLEdBQUcsRUFBRSxDQUFDO1FBQzNCLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO0lBT3BDLENBQUM7SUFFRSxPQUFPLENBQUMsT0FBZSxFQUFFLFVBQXlCLEVBQUU7UUFDekQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcs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QkFEckIsVUFBVTs7MEJBWU4sTUFBTTsyQkFBQyxZQUFZOzswQkFDbkIsTUFBTTsyQkFBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkRlc3Ryb3ksIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBNYXREaWFsb2cgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xuXG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBvZiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBUb2FzdHJTZXJ2aWNlLCBUT0FTVF9DT05GSUcsIFRvYXN0VG9rZW4gfSBmcm9tICduZ3gtdG9hc3RyJztcblxuaW1wb3J0IHsgRnNNZXNzYWdlRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi9jb21wb25lbnRzL21lc3NhZ2UtZGlhbG9nL21lc3NhZ2UtZGlhbG9nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBNZXNzYWdlVHlwZSwgTWVzc2FnZU1vZGUsIE1lc3NhZ2VDb25maWcgfSBmcm9tICcuL2VudW1zJztcbmltcG9ydCB7IEZTX01FU1NBR0VfQ09ORklHIH0gZnJvbSAnLi9pbmplY3RvcnMvbWVzc2FnZS1jb25maWcnO1xuaW1wb3J0IHsgRnNNZXNzYWdlQ29uZmlnIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IE1lc3NhZ2VEaWFsb2dDb25maWcgfSBmcm9tICcuL2ludGVyZmFjZXMvbWVzc2FnZS1kaWFsb2ctY29uZmlnJztcbmltcG9ydCB7IE1lc3NhZ2VUb2FzdENvbmZpZyB9IGZyb20gJy4vaW50ZXJmYWNlcy9tZXNzYWdlLXRvYXN0LWNvbmZpZyc7XG5pbXBvcnQgeyBNZXNzYWdlQmFubmVyQ29uZmlnIH0gZnJvbSAnLi9pbnRlcmZhY2VzL21lc3NhZ2UtYmFubmVyLWNvbmZpZyc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZzTWVzc2FnZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cbiAgcHVibGljIGJhbm5lck1lc3NhZ2VzJCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgcHJpdmF0ZSBfZGlhbG9ncyA9IDA7XG4gIHByaXZhdGUgX2RpYWxvZ3NNZXNzYWdlc1F1ZXVlID0gW107XG4gIHByaXZhdGUgX2Rlc3Ryb3kkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHRvYXN0cjogVG9hc3RyU2VydmljZSxcbiAgICBwcml2YXRlIG1hdERpYWxvZzogTWF0RGlhbG9nLFxuICAgIEBJbmplY3QoVE9BU1RfQ09ORklHKSBwcml2YXRlIF90b2FzdFRva2VuOiBUb2FzdFRva2VuLFxuICAgIEBJbmplY3QoRlNfTUVTU0FHRV9DT05GSUcpIHByaXZhdGUgX2NvbmZpZzogRnNNZXNzYWdlQ29uZmlnLFxuICApIHsgfVxuXG4gIHB1YmxpYyBzdWNjZXNzKG1lc3NhZ2U6IHN0cmluZywgb3B0aW9uczogTWVzc2FnZUNvbmZpZyA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5zaG93KE1lc3NhZ2VUeXBlLlN1Y2Nlc3MsIG1lc3NhZ2UsIHsgdGl0bGU6ICdTdWNjZXNzJywgbW9kZTogdGhpcy5fY29uZmlnLnN1Y2Nlc3NNb2RlLCAuLi5vcHRpb25zIH0pO1xuICB9XG5cbiAgcHVibGljIGluZm8obWVzc2FnZTogc3RyaW5nLCBvcHRpb25zOiBNZXNzYWdlQ29uZmlnID0ge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLnNob3coTWVzc2FnZVR5cGUuSW5mbywgbWVzc2FnZSwgeyB0aXRsZTogJ0luZm9ybWF0aW9uJywgbW9kZTogdGhpcy5fY29uZmlnLmluZm9Nb2RlLCAuLi5vcHRpb25zIH0pO1xuICB9XG5cbiAgcHVibGljIGVycm9yKG1lc3NhZ2U6IHN0cmluZywgb3B0aW9uczogTWVzc2FnZUNvbmZpZyA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5zaG93KE1lc3NhZ2VUeXBlLkVycm9yLCBtZXNzYWdlLCB7IHRpdGxlOiAnQXR0ZW50aW9uJywgbW9kZTogdGhpcy5fY29uZmlnLmVycm9yTW9kZSwgLi4ub3B0aW9ucyB9KTtcbiAgfVxuXG4gIHB1YmxpYyB3YXJuaW5nKG1lc3NhZ2U6IHN0cmluZywgb3B0aW9uczogTWVzc2FnZUNvbmZpZyA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5zaG93KE1lc3NhZ2VUeXBlLldhcm5pbmcsIG1lc3NhZ2UsIHsgdGl0bGU6ICdXYXJuaW5nJywgbW9kZTogdGhpcy5fY29uZmlnLndhcm5pbmdNb2RlLCAuLi5vcHRpb25zIH0pO1xuICB9XG5cbiAgcHVibGljIHNob3codHlwZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIG9wdGlvbnM6IE1lc3NhZ2VDb25maWcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGlmIChvcHRpb25zLmljb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy5pY29uID0gdGhpcy5nZXRJY29uTmFtZSh0eXBlKTtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKG9wdGlvbnMubW9kZSkge1xuICAgICAgY2FzZSBNZXNzYWdlTW9kZS5Ub2FzdDpcbiAgICAgICAgdGhpcy50b2FzdCh0eXBlLCBtZXNzYWdlLCBvcHRpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1lc3NhZ2VNb2RlLkJhbm5lcjpcbiAgICAgICAgdGhpcy5iYW5uZXIodHlwZSwgbWVzc2FnZSwgb3B0aW9ucyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBNZXNzYWdlTW9kZS5EaWFsb2c6XG4gICAgICAgIHJldHVybiB0aGlzLmRpYWxvZyh0eXBlLCBtZXNzYWdlLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb2YoKTtcbiAgfVxuXG4gIHB1YmxpYyBoaWRlKCk6IHZvaWQge1xuICAgIHRoaXMudG9hc3RyLmNsZWFyKCk7XG4gICAgdGhpcy5iYW5uZXJNZXNzYWdlcyQubmV4dCgpO1xuICAgIHRoaXMubWF0RGlhbG9nLmNsb3NlQWxsKCk7XG4gIH1cblxuICBwdWJsaWMgdG9hc3QodHlwZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIG9wdGlvbnM6IE1lc3NhZ2VUb2FzdENvbmZpZyk6IHZvaWQge1xuICAgIGNvbnN0IG9wdHM6IGFueSA9IG9wdGlvbnM7XG4gICAgb3B0cy5lbmFibGVIdG1sID0gdHJ1ZTtcbiAgICBvcHRzLnBvc2l0aW9uQ2xhc3MgPSBvcHRpb25zLnBvc2l0aW9uQ2xhc3MgfHwgdGhpcy5fdG9hc3RUb2tlbi5jb25maWcucG9zaXRpb25DbGFzcyB8fCAndG9hc3QtYm90dG9tLWxlZnQnO1xuICAgIG9wdHMudGltZU91dCA9IChvcHRpb25zLnRpbWVvdXQgfHwgdGhpcy5fY29uZmlnLnRvYXN0VGltZW91dCkgKiAxMDAwO1xuXG4gICAgY29uc3QgaWNvbiA9IG9wdHMuaWNvbiA/IGA8ZGl2IGNsYXNzPVwibWF0LWljb24gbWF0ZXJpYWwtaWNvbnNcIj4keyBvcHRzLmljb24gfTwvZGl2PmAgOiAnJztcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGA8ZGl2IGNsYXNzPVwibWF0LXRvYXN0LWNvbnRlbnRcIj4ke2ljb259PGRpdiBjbGFzcz1cIm1lc3NhZ2VcIj4ke21lc3NhZ2V9PC9kaXY+PC9kaXY+YDtcblxuICAgIHRoaXMudG9hc3RyW3R5cGVdKHRlbXBsYXRlLCAnJywgb3B0cyk7XG4gIH1cblxuICBwdWJsaWMgYmFubmVyKHR5cGU6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCBvcHRpb25zOiBNZXNzYWdlQmFubmVyQ29uZmlnKTogdm9pZCB7XG4gICAgdGhpcy5iYW5uZXJNZXNzYWdlcyQubmV4dCh7XG4gICAgICB0eXBlOiB0eXBlLFxuICAgICAgbXNnOiBtZXNzYWdlLFxuICAgICAgdGltZW91dDogKG9wdGlvbnMudGltZW91dCB8fCB0aGlzLl9jb25maWcuYmFubmVyVGltZW91dCB8fCA1KSAqIDEwMDBcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBkaWFsb2codHlwZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIG9wdGlvbnM6IE1lc3NhZ2VEaWFsb2dDb25maWcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHR5cGVNZXNzYWdlID0gdHlwZSArIG1lc3NhZ2U7XG5cbiAgICBpZiAodGhpcy5fZGlhbG9nc01lc3NhZ2VzUXVldWUuaW5kZXhPZih0eXBlTWVzc2FnZSkgPiAtMSkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cblxuICAgIHRoaXMuX2RpYWxvZ3NNZXNzYWdlc1F1ZXVlLnB1c2godHlwZU1lc3NhZ2UpO1xuICAgIHRoaXMuX2RpYWxvZ3MrKztcblxuICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMubWF0RGlhbG9nLm9wZW4oRnNNZXNzYWdlRGlhbG9nQ29tcG9uZW50LCB7XG4gICAgICAvKiBXYWl0aW5nIGZvciBNYXREaWFsb2cgdG8gc3VwcG9ydCBhcnJheSBvZiBjbGFzc2VzIGxpa2UgcGFuZWxDbGFzc1xuICAgICAgYmFja2Ryb3BDbGFzczogWydmcy1tZXNzYWdlLWJhY2tkcm9wJyxcbiAgICAgICAgICAgICAgICAgICAgICAnZnMtbWVzc2FnZS1iYWNrZHJvcC0nICsgdHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmJhY2tkcm9wQ2xhc3NdLCAqL1xuICAgICAgYmFja2Ryb3BDbGFzczogb3B0aW9ucy5iYWNrZHJvcENsYXNzLFxuICAgICAgd2lkdGg6IG9wdGlvbnMud2lkdGggfHwgdGhpcy5fY29uZmlnLmRpYWxvZ1dpZHRoLFxuICAgICAgZGF0YTogeyB0eXBlOiB0eXBlLCBtZXNzYWdlOiBtZXNzYWdlLCBvcHRpb25zOiBvcHRpb25zLCBpY29uOiB0aGlzLmdldEljb25OYW1lKHR5cGUpIH0sXG4gICAgICBwYW5lbENsYXNzOiBbXG4gICAgICAgICdmcy1tZXNzYWdlLXBhbmUnLFxuICAgICAgICAnZnMtbWVzc2FnZS1wYW5lLScgKyB0eXBlLFxuICAgICAgICBvcHRpb25zLnBhbmVsQ2xhc3MsXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgZGlhbG9nUmVmLmFmdGVyQ2xvc2VkKClcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuX2RpYWxvZ3MtLTtcblxuICAgICAgICBjb25zdCBkaWFsb2dNZXNzYWdlSWR4ID0gdGhpcy5fZGlhbG9nc01lc3NhZ2VzUXVldWUuaW5kZXhPZih0eXBlTWVzc2FnZSk7XG4gICAgICAgIGlmIChkaWFsb2dNZXNzYWdlSWR4ID4gLTEpIHtcbiAgICAgICAgICB0aGlzLl9kaWFsb2dzTWVzc2FnZXNRdWV1ZS5zcGxpY2UoZGlhbG9nTWVzc2FnZUlkeCwgMSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgcmV0dXJuIGRpYWxvZ1JlZi5hZnRlckNsb3NlZCgpO1xuICB9XG5cbiAgcHVibGljIGdldEljb25OYW1lKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIE1lc3NhZ2VUeXBlLlN1Y2Nlc3M6XG4gICAgICAgIHJldHVybiAnZG9uZSc7XG4gICAgICBjYXNlIE1lc3NhZ2VUeXBlLkVycm9yOlxuICAgICAgICByZXR1cm4gJ3JlcG9ydF9wcm9ibGVtJztcbiAgICAgIGNhc2UgTWVzc2FnZVR5cGUuSW5mbzpcbiAgICAgICAgcmV0dXJuICdpbmZvJztcbiAgICAgIGNhc2UgTWVzc2FnZVR5cGUuV2FybmluZzpcbiAgICAgICAgcmV0dXJuICdyZXBvcnRfcHJvYmxlbSc7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2Rlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbn1cbiJdfQ==