import { Injectable } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { FsStore } from './store.service';
import { isAfter, subMinutes } from 'date-fns';
import { pickBy, cloneDeep } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "./store.service";
import * as i2 from "@angular/router";
export class FsPersistanceStore {
    constructor(_store, _route) {
        this._store = _store;
        this._route = _route;
        this._enabled = false;
        this._openedInDialog = false;
        // Initialize store
        if (!this._store.get(this.STORE_KEY)) {
            this._store.set(this.STORE_KEY, {});
        }
    }
    get enabled() {
        return this._enabled;
    }
    get value() {
        return cloneDeep(this._value);
    }
    get namespace() {
        return this._namespace;
    }
    setConfig(persistanceConfig, namespace, inDialog = false) {
        this._namespace = namespace;
        this._openedInDialog = inDialog;
        if (typeof persistanceConfig === 'object') {
            this._persistConfig = Object.assign({}, persistanceConfig);
        }
        else {
            this._persistConfig = {};
        }
        if (this._route.snapshot.queryParams.persist === 'clear') {
            this.save({}, true);
        }
        // if filter in dialog - we should disable persistance
        if (this._route.snapshot.queryParams.persist !== 'disable'
            && persistanceConfig
            && !this._openedInDialog) {
            this._enabled = true;
        }
        this.restore();
    }
    save(data, force = false) {
        if (!this._enabled && !force) {
            return;
        }
        if (typeof data === 'object') {
            data = pickBy(data, (val) => {
                return val !== null && val !== void 0;
            });
        }
        // if filter in dialog - we should disable persistance
        if (!this._namespace && !force) {
            return;
        }
        this._putDataToLocalStore({
            data,
            date: new Date()
        });
    }
    /**
     * Restoring values from local storage
     */
    restore() {
        if (!this.enabled) {
            return;
        }
        let value = this._retrieveDataFromLocalStore();
        // Default value if data doesn't exists
        if (!value || !value.data) {
            value = { data: {}, date: new Date() };
        }
        else if (value) {
            // Check if data is too old
            if (this._persistConfig.timeout) {
                const date = new Date(value.date);
                if (isAfter(subMinutes(date, this._persistConfig.timeout), new Date())) {
                    value = { data: {}, date: new Date() };
                }
            }
        }
        this._value = value;
    }
    clear() {
        this.save({});
    }
    getDataFromScope(name) {
        return this.value.data[name];
    }
    saveDataToScope(name, value) {
        const data = Object.assign(Object.assign({}, this.value.data), { [name]: value });
        this.save(data);
    }
    _putDataToLocalStore(value) {
        const storeData = this._store.get(this.STORE_KEY) || {};
        storeData[this._namespace] = value;
        this._value = value;
        this._store.set(this.STORE_KEY, storeData);
    }
    _retrieveDataFromLocalStore() {
        const storeData = this._store.get(this.STORE_KEY);
        if (storeData) {
            return storeData[this._namespace];
        }
        else {
            return {};
        }
    }
}
FsPersistanceStore.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsPersistanceStore, deps: [{ token: i1.FsStore }, { token: i2.ActivatedRoute }], target: i0.ɵɵFactoryTarget.Injectable });
FsPersistanceStore.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsPersistanceStore });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsPersistanceStore, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.FsStore }, { type: i2.ActivatedRoute }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdGFuY2Utc3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYXBwL3NlcnZpY2VzL3BlcnNpc3RhbmNlLXN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRWpELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUxQyxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQzs7OztBQU05QyxNQUFNLE9BQU8sa0JBQWtCO0lBVTdCLFlBQ1ksTUFBZSxFQUNmLE1BQXNCO1FBRHRCLFdBQU0sR0FBTixNQUFNLENBQVM7UUFDZixXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQVR4QixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBRWpCLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBU2hDLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDckM7SUFDSCxDQUFDO0lBRUQsSUFBVyxPQUFPO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBVyxLQUFLO1FBQ2QsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3pCLENBQUM7SUFFTSxTQUFTLENB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QyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRU0sZUFBZSxDQUFtQixJQUFZLEVBQUUsS0FBaUI7UUFDdEUsTUFBTSxJQUFJLG1DQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUNsQixDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssR0FDZCxDQUFDO1FBRUYsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRU8sb0JBQW9CLENBQUMsS0FBSztRQUNoQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3hELFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBRW5DLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBRXBCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVPLDJCQUEyQjtRQUNqQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFbEQsSUFBSSxTQUFTLEVBQUU7WUFDYixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDbkM7YUFBTTtZQUNMLE9BQU8sRUFBRSxDQUFDO1NBQ1g7SUFDSCxDQUFDOztnSEE3SVUsa0JBQWtCO29IQUFsQixrQkFBa0I7NEZBQWxCLGtCQUFrQjtrQkFEOUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgRnNTdG9yZSB9IGZyb20gJy4vc3RvcmUuc2VydmljZSc7XG5cbmltcG9ydCB7IGlzQWZ0ZXIsIHN1Yk1pbnV0ZXMgfSBmcm9tICdkYXRlLWZucyc7XG5pbXBvcnQgeyBwaWNrQnksIGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbmltcG9ydCB7IEZzUGVyc2lzdGFuY2UsIEZzUGVyc2lzdGFuY2VDb25maWcgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3BlcnNpc3RhbmNlLmludGVyZmFjZSc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZzUGVyc2lzdGFuY2VTdG9yZTxUIGV4dGVuZHMgRnNQZXJzaXN0YW5jZSA9IGFueSwgVERhdGEgPSBhbnk+IHtcblxuICBwcm90ZWN0ZWQgX3ZhbHVlOiB7IGRhdGE6IFREYXRhLCBkYXRlOiBEYXRlIH07XG4gIHByb3RlY3RlZCBfZW5hYmxlZCA9IGZhbHNlO1xuICBwcm90ZWN0ZWQgX25hbWVzcGFjZTogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX29wZW5lZEluRGlhbG9nID0gZmFsc2U7XG4gIHByb3RlY3RlZCBfcGVyc2lzdENvbmZpZzogRnNQZXJzaXN0YW5jZUNvbmZpZztcblxuICBwcm90ZWN0ZWQgU1RPUkVfS0VZOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIF9zdG9yZTogRnNTdG9yZSxcbiAgICBwcm90ZWN0ZWQgX3JvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgKSB7XG4gICAgLy8gSW5pdGlhbGl6ZSBzdG9yZVxuICAgIGlmICghdGhpcy5fc3RvcmUuZ2V0KHRoaXMuU1RPUkVfS0VZKSkge1xuICAgICAgdGhpcy5fc3RvcmUuc2V0KHRoaXMuU1RPUkVfS0VZLCB7fSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBlbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9lbmFibGVkO1xuICB9XG5cbiAgcHVibGljIGdldCB2YWx1ZSgpOiB7IGRhdGE6IFREYXRhLCBkYXRlOiBEYXRlIH0ge1xuICAgIHJldHVybiBjbG9uZURlZXAodGhpcy5fdmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGdldCBuYW1lc3BhY2UoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fbmFtZXNwYWNlO1xuICB9XG5cbiAgcHVibGljIHNldENvbmZpZyhwZXJzaXN0YW5jZUNvbmZpZzogVCwgbmFtZXNwYWNlOiBzdHJpbmcsIGluRGlhbG9nID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLl9uYW1lc3BhY2UgPSBuYW1lc3BhY2U7XG4gICAgdGhpcy5fb3BlbmVkSW5EaWFsb2cgPSBpbkRpYWxvZztcblxuICAgIGlmICh0eXBlb2YgcGVyc2lzdGFuY2VDb25maWcgPT09ICdvYmplY3QnKSB7XG4gICAgICB0aGlzLl9wZXJzaXN0Q29uZmlnID0geyAuLi48RnNQZXJzaXN0YW5jZUNvbmZpZz5wZXJzaXN0YW5jZUNvbmZpZyB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9wZXJzaXN0Q29uZmlnID0ge307XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3JvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1zLnBlcnNpc3QgPT09ICdjbGVhcicpIHtcbiAgICAgIHRoaXMuc2F2ZSh7fSwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgLy8gaWYgZmlsdGVyIGluIGRpYWxvZyAtIHdlIHNob3VsZCBkaXNhYmxlIHBlcnNpc3RhbmNlXG4gICAgaWYgKFxuICAgICAgdGhpcy5fcm91dGUuc25hcHNob3QucXVlcnlQYXJhbXMucGVyc2lzdCAhPT0gJ2Rpc2FibGUnXG4gICAgICAmJiBwZXJzaXN0YW5jZUNvbmZpZ1xuICAgICAgJiYgIXRoaXMuX29wZW5lZEluRGlhbG9nXG4gICAgKSB7XG4gICAgICB0aGlzLl9lbmFibGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnJlc3RvcmUoKTtcbiAgfVxuXG4gIHB1YmxpYyBzYXZlKGRhdGEsIGZvcmNlID0gZmFsc2UpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuX2VuYWJsZWQgJiYgIWZvcmNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBkYXRhID09PSAnb2JqZWN0Jykge1xuICAgICAgZGF0YSA9IHBpY2tCeShkYXRhLCAodmFsKSA9PiB7XG4gICAgICAgIHJldHVybiB2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDA7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBpZiBmaWx0ZXIgaW4gZGlhbG9nIC0gd2Ugc2hvdWxkIGRpc2FibGUgcGVyc2lzdGFuY2VcbiAgICBpZiAoIXRoaXMuX25hbWVzcGFjZSAmJiAhZm9yY2UpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLl9wdXREYXRhVG9Mb2NhbFN0b3JlKHtcbiAgICAgIGRhdGEsXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXN0b3JpbmcgdmFsdWVzIGZyb20gbG9jYWwgc3RvcmFnZVxuICAgKi9cbiAgcHVibGljIHJlc3RvcmUoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgdmFsdWUgPSB0aGlzLl9yZXRyaWV2ZURhdGFGcm9tTG9jYWxTdG9yZSgpO1xuXG4gICAgLy8gRGVmYXVsdCB2YWx1ZSBpZiBkYXRhIGRvZXNuJ3QgZXhpc3RzXG4gICAgaWYgKCF2YWx1ZSB8fCAhdmFsdWUuZGF0YSkge1xuICAgICAgdmFsdWUgPSB7IGRhdGE6IHt9LCBkYXRlOiBuZXcgRGF0ZSgpIH07XG4gICAgfSBlbHNlIGlmICh2YWx1ZSkge1xuICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyB0b28gb2xkXG4gICAgICBpZiAodGhpcy5fcGVyc2lzdENvbmZpZy50aW1lb3V0KSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh2YWx1ZS5kYXRlKTtcblxuICAgICAgICBpZiAoaXNBZnRlcihzdWJNaW51dGVzKGRhdGUsIHRoaXMuX3BlcnNpc3RDb25maWcudGltZW91dCksIG5ldyBEYXRlKCkpKSB7XG4gICAgICAgICAgdmFsdWUgPSB7IGRhdGE6IHt9LCBkYXRlOiBuZXcgRGF0ZSgpIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLl92YWx1ZSA9IHZhbHVlO1xuICB9XG5cbiAgcHVibGljIGNsZWFyKCkge1xuICAgIHRoaXMuc2F2ZSh7fSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RGF0YUZyb21TY29wZTxUU2NvcGVEYXRhID0gYW55PihuYW1lOiBzdHJpbmcpOiBUU2NvcGVEYXRhIHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZS5kYXRhW25hbWVdO1xuICB9XG5cbiAgcHVibGljIHNhdmVEYXRhVG9TY29wZTxUU2NvcGVEYXRhID0gYW55PihuYW1lOiBzdHJpbmcsIHZhbHVlOiBUU2NvcGVEYXRhKTogdm9pZCB7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIC4uLnRoaXMudmFsdWUuZGF0YSxcbiAgICAgIFtuYW1lXTogdmFsdWVcbiAgICB9O1xuXG4gICAgdGhpcy5zYXZlKGRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcHV0RGF0YVRvTG9jYWxTdG9yZSh2YWx1ZSkge1xuICAgIGNvbnN0IHN0b3JlRGF0YSA9IHRoaXMuX3N0b3JlLmdldCh0aGlzLlNUT1JFX0tFWSkgfHwge307XG4gICAgc3RvcmVEYXRhW3RoaXMuX25hbWVzcGFjZV0gPSB2YWx1ZTtcblxuICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG5cbiAgICB0aGlzLl9zdG9yZS5zZXQodGhpcy5TVE9SRV9LRVksIHN0b3JlRGF0YSk7XG4gIH1cblxuICBwcml2YXRlIF9yZXRyaWV2ZURhdGFGcm9tTG9jYWxTdG9yZSgpIHtcbiAgICBjb25zdCBzdG9yZURhdGEgPSB0aGlzLl9zdG9yZS5nZXQodGhpcy5TVE9SRV9LRVkpO1xuXG4gICAgaWYgKHN0b3JlRGF0YSkge1xuICAgICAgcmV0dXJuIHN0b3JlRGF0YVt0aGlzLl9uYW1lc3BhY2VdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9XG59XG4iXX0=