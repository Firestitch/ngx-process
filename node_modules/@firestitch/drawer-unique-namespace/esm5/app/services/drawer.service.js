import { __decorate, __metadata, __param } from "tslib";
import { Injectable, Injector, OnDestroy, Optional, SkipSelf } from '@angular/core';
import { Overlay, OverlayConfig, OverlayRef } from '@angular/cdk/overlay';
import { ComponentPortal, PortalInjector } from '@angular/cdk/portal';
import { Subject, merge } from 'rxjs';
import { take, takeUntil } from 'rxjs/operators';
import { FsDrawerComponent } from '../components/drawer/drawer.component';
import { DrawerRef } from '../classes/drawer-ref';
import { DrawerData } from '../classes/drawer-data';
import { DRAWER_DATA } from './drawer-data';
var FsDrawerService = /** @class */ (function () {
    function FsDrawerService(_parentDrawerService, _overlay, _injector) {
        this._parentDrawerService = _parentDrawerService;
        this._overlay = _overlay;
        this._injector = _injector;
        this._drawerRefs = new Set();
        this._destroy$ = new Subject();
    }
    FsDrawerService.prototype.ngOnDestroy = function () {
        this._destroy$.next();
        this._destroy$.complete();
    };
    FsDrawerService.prototype.open = function (component, config) {
        var _this = this;
        var overlayRef = this._createOverlay();
        var dataFactory = DrawerData.createWithProxy(config.data);
        var drawerRef = new DrawerRef(overlayRef, dataFactory, config);
        var containerRef = this._attachDrawerContainer(overlayRef, drawerRef, dataFactory);
        var componentRef = this._attachComponent(component, containerRef, drawerRef, dataFactory);
        drawerRef.containerRef = containerRef;
        containerRef.setDrawerRef(drawerRef);
        drawerRef.componentRef = componentRef;
        drawerRef.events();
        drawerRef.open();
        this._storeDrawerRef(drawerRef);
        merge(drawerRef.afterOpened$, drawerRef.afterClosed$)
            .pipe(takeUntil(this._destroy$))
            .subscribe(function () {
            setTimeout(function () {
                _this._applyBackdrop();
                _this._applyBodyOpenClass();
            });
        });
        return drawerRef;
    };
    FsDrawerService.prototype.closeAll = function () {
        this._drawerRefs.forEach(function (ref) { return ref.close(); });
        if (this._parentDrawerService) {
            this._parentDrawerService.closeAll();
        }
    };
    FsDrawerService.prototype._applyBackdrop = function () {
        var _this = this;
        Array.from(this._drawerRefs)
            .forEach(function (drawerRef, index) {
            var backdrop = drawerRef.overlayRef.backdropElement;
            if (backdrop) {
                if (index && index === (_this._drawerRefs.size - 1)) {
                    backdrop.classList.add('fs-drawer-backdrop-active');
                }
                else {
                    backdrop.classList.remove('fs-drawer-backdrop-active');
                }
            }
        });
    };
    FsDrawerService.prototype._applyBodyOpenClass = function () {
        if (this._drawerRefs.size) {
            document.body.classList.add('fs-drawer-open');
        }
        else {
            document.body.classList.remove('fs-drawer-open');
        }
    };
    FsDrawerService.prototype._storeDrawerRef = function (ref) {
        var _this = this;
        this._drawerRefs.add(ref);
        this._pushDrawersCascade();
        ref.destroy$
            .pipe(take(1), takeUntil(this._destroy$))
            .subscribe(function () {
            _this._drawerRefs.delete(ref);
        });
    };
    /**
     * In case, when we want to open more than 1 drawer
     * our previously opened drawers should be visible
     *
     *      d1   d2   d3
     *     ---- ---- ---
     *    | x  | x1 | x2
     *    | y  | y1 | y2
     *    | z  | z1 | z2
     *     ---- ---- ---
     *
     * Where d1, d2 - previously opened drawers
     * d1 and d2 must be pushed left to be visible under just opened d3
     */
    FsDrawerService.prototype._pushDrawersCascade = function () {
        var _this = this;
        if (this._drawerRefs.size > 1) {
            // SetTimeout should be here because we must wait render newly opened drawer
            // to be able to get his width
            setTimeout(function () {
                var refsArr = Array.from(_this._drawerRefs.values());
                for (var i = refsArr.length - 1; i > 0; i--) {
                    var prevRef = refsArr[i - 1];
                    var currRef = refsArr[i];
                    prevRef.resizeController.pushMainWidth(currRef);
                }
            });
        }
    };
    FsDrawerService.prototype._createOverlay = function () {
        var overlayConfig = this._getOverlayConfig();
        return this._overlay.create(overlayConfig);
    };
    FsDrawerService.prototype._getOverlayConfig = function () {
        return new OverlayConfig({
            hasBackdrop: true,
            backdropClass: 'fs-drawer-backdrop'
        });
    };
    FsDrawerService.prototype._attachDrawerContainer = function (overlayRef, drawerRef, dataFactory) {
        var injector = this._createInjector(drawerRef, dataFactory);
        var containerPortal = new ComponentPortal(FsDrawerComponent, undefined, injector);
        var containerRef = overlayRef.attach(containerPortal);
        return containerRef.instance;
    };
    FsDrawerService.prototype._attachComponent = function (componentRef, drawerContainer, drawerRef, dataFactory) {
        var injector = this._createInjector(drawerRef, dataFactory);
        return drawerContainer.attachComponentPortal(new ComponentPortal(componentRef, undefined, injector));
    };
    FsDrawerService.prototype._createInjector = function (componentRef, dataFactory) {
        var injectionTokens = new WeakMap([
            [DrawerRef, componentRef],
            [DRAWER_DATA, dataFactory]
        ]);
        return new PortalInjector(this._injector, injectionTokens);
    };
    FsDrawerService.ctorParameters = function () { return [
        { type: FsDrawerService, decorators: [{ type: Optional }, { type: SkipSelf }] },
        { type: Overlay },
        { type: Injector }
    ]; };
    FsDrawerService = __decorate([
        Injectable(),
        __param(0, Optional()), __param(0, SkipSelf()),
        __metadata("design:paramtypes", [FsDrawerService,
            Overlay,
            Injector])
    ], FsDrawerService);
    return FsDrawerService;
}());
export { FsDrawerService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmlyZXN0aXRjaC9kcmF3ZXIvIiwic291cmNlcyI6WyJhcHAvc2VydmljZXMvZHJhd2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQWlCLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXJGLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFTLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVwRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTVDO0lBS0UseUJBQ2tDLG9CQUFxQyxFQUM3RCxRQUFpQixFQUNqQixTQUFtQjtRQUZLLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBaUI7UUFDN0QsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQixjQUFTLEdBQVQsU0FBUyxDQUFVO1FBTnJCLGdCQUFXLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7UUFDeEMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFNbEMsQ0FBQztJQUVNLHFDQUFXLEdBQWxCO1FBQ0UsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN0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Z0JBekt1RCxlQUFlLHVCQUFwRSxRQUFRLFlBQUksUUFBUTtnQkFDSCxPQUFPO2dCQUNOLFFBQVE7O0lBUmxCLGVBQWU7UUFEM0IsVUFBVSxFQUFFO1FBT1IsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsUUFBUSxFQUFFLENBQUE7eUNBQStCLGVBQWU7WUFDbkQsT0FBTztZQUNOLFFBQVE7T0FSbEIsZUFBZSxDQWtMM0I7SUFBRCxzQkFBQztDQUFBLEFBbExELElBa0xDO1NBbExZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgT25EZXN0cm95LCBPcHRpb25hbCwgU2tpcFNlbGYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE92ZXJsYXksIE92ZXJsYXlDb25maWcsIE92ZXJsYXlSZWYgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIENvbXBvbmVudFR5cGUsIFBvcnRhbEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5cbmltcG9ydCB7IFN1YmplY3QsIG1lcmdlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlLCB0YWtlVW50aWwsIGRlbGF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBGc0RyYXdlckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvZHJhd2VyL2RyYXdlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgRHJhd2VyUmVmIH0gZnJvbSAnLi4vY2xhc3Nlcy9kcmF3ZXItcmVmJztcbmltcG9ydCB7IERyYXdlckRhdGEgfSBmcm9tICcuLi9jbGFzc2VzL2RyYXdlci1kYXRhJztcbmltcG9ydCB7IElEcmF3ZXJDb25maWcgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2RyYXdlci1jb25maWcuaW50ZXJmYWNlJztcbmltcG9ydCB7IERSQVdFUl9EQVRBIH0gZnJvbSAnLi9kcmF3ZXItZGF0YSc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZzRHJhd2VyU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cbiAgcHJpdmF0ZSBfZHJhd2VyUmVmcyA9IG5ldyBTZXQ8RHJhd2VyUmVmPGFueT4+KCk7XG4gIHByaXZhdGUgX2Rlc3Ryb3kkID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKSBAU2tpcFNlbGYoKSBwcml2YXRlIF9wYXJlbnREcmF3ZXJTZXJ2aWNlOiBGc0RyYXdlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBfb3ZlcmxheTogT3ZlcmxheSxcbiAgICBwcml2YXRlIF9pbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLl9kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBvcGVuPFREYXRhID0gYW55Pihjb21wb25lbnQ6IENvbXBvbmVudFR5cGU8YW55PiwgY29uZmlnPzogSURyYXdlckNvbmZpZzxURGF0YT4pIHtcbiAgICBjb25zdCBvdmVybGF5UmVmID0gdGhpcy5fY3JlYXRlT3ZlcmxheSgpO1xuXG4gICAgY29uc3QgZGF0YUZhY3RvcnkgPSBEcmF3ZXJEYXRhLmNyZWF0ZVdpdGhQcm94eShjb25maWcuZGF0YSk7XG4gICAgY29uc3QgZHJhd2VyUmVmID0gbmV3IERyYXdlclJlZihvdmVybGF5UmVmLCBkYXRhRmFjdG9yeSwgY29uZmlnKTtcblxuICAgIGNvbnN0IGNvbnRhaW5lclJlZiA9IHRoaXMuX2F0dGFjaERyYXdlckNvbnRhaW5lcihvdmVybGF5UmVmLCBkcmF3ZXJSZWYsIGRhdGFGYWN0b3J5KTtcbiAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLl9hdHRhY2hDb21wb25lbnQoY29tcG9uZW50LCBjb250YWluZXJSZWYsIGRyYXdlclJlZiwgZGF0YUZhY3RvcnkpO1xuXG4gICAgZHJhd2VyUmVmLmNvbnRhaW5lclJlZiA9IGNvbnRhaW5lclJlZjtcbiAgICBjb250YWluZXJSZWYuc2V0RHJhd2VyUmVmKGRyYXdlclJlZik7XG5cbiAgICBkcmF3ZXJSZWYuY29tcG9uZW50UmVmID0gY29tcG9uZW50UmVmO1xuXG4gICAgZHJhd2VyUmVmLmV2ZW50cygpO1xuICAgIGRyYXdlclJlZi5vcGVuKCk7XG5cbiAgICB0aGlzLl9zdG9yZURyYXdlclJlZihkcmF3ZXJSZWYpO1xuXG4gICAgbWVyZ2UoXG4gICAgICBkcmF3ZXJSZWYuYWZ0ZXJPcGVuZWQkLFxuICAgICAgZHJhd2VyUmVmLmFmdGVyQ2xvc2VkJFxuICAgIClcbiAgICAucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JClcbiAgICApXG4gICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5fYXBwbHlCYWNrZHJvcCgpO1xuICAgICAgICB0aGlzLl9hcHBseUJvZHlPcGVuQ2xhc3MoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGRyYXdlclJlZjtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZUFsbCgpIHtcbiAgICB0aGlzLl9kcmF3ZXJSZWZzLmZvckVhY2goKHJlZikgPT4gcmVmLmNsb3NlKCkpO1xuXG4gICAgaWYgKHRoaXMuX3BhcmVudERyYXdlclNlcnZpY2UpIHtcbiAgICAgIHRoaXMuX3BhcmVudERyYXdlclNlcnZpY2UuY2xvc2VBbGwoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9hcHBseUJhY2tkcm9wKCkge1xuICAgIEFycmF5LmZyb20odGhpcy5fZHJhd2VyUmVmcylcbiAgICAuZm9yRWFjaCgoZHJhd2VyUmVmLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgYmFja2Ryb3AgPSBkcmF3ZXJSZWYub3ZlcmxheVJlZi5iYWNrZHJvcEVsZW1lbnQ7XG5cbiAgICAgIGlmIChiYWNrZHJvcCkge1xuICAgICAgICBpZiAoaW5kZXggJiYgaW5kZXggPT09ICh0aGlzLl9kcmF3ZXJSZWZzLnNpemUgLSAxKSkge1xuICAgICAgICAgIGJhY2tkcm9wLmNsYXNzTGlzdC5hZGQoJ2ZzLWRyYXdlci1iYWNrZHJvcC1hY3RpdmUnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBiYWNrZHJvcC5jbGFzc0xpc3QucmVtb3ZlKCdmcy1kcmF3ZXItYmFja2Ryb3AtYWN0aXZlJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5Qm9keU9wZW5DbGFzcygpIHtcbiAgICBpZiAodGhpcy5fZHJhd2VyUmVmcy5zaXplKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2ZzLWRyYXdlci1vcGVuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnZnMtZHJhd2VyLW9wZW4nKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9zdG9yZURyYXdlclJlZihyZWYpIHtcbiAgICB0aGlzLl9kcmF3ZXJSZWZzLmFkZChyZWYpO1xuXG4gICAgdGhpcy5fcHVzaERyYXdlcnNDYXNjYWRlKCk7XG5cbiAgICByZWYuZGVzdHJveSRcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlKDEpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuX2RyYXdlclJlZnMuZGVsZXRlKHJlZik7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbiBjYXNlLCB3aGVuIHdlIHdhbnQgdG8gb3BlbiBtb3JlIHRoYW4gMSBkcmF3ZXJcbiAgICogb3VyIHByZXZpb3VzbHkgb3BlbmVkIGRyYXdlcnMgc2hvdWxkIGJlIHZpc2libGVcbiAgICpcbiAgICogICAgICBkMSAgIGQyICAgZDNcbiAgICogICAgIC0tLS0gLS0tLSAtLS1cbiAgICogICAgfCB4ICB8IHgxIHwgeDJcbiAgICogICAgfCB5ICB8IHkxIHwgeTJcbiAgICogICAgfCB6ICB8IHoxIHwgejJcbiAgICogICAgIC0tLS0gLS0tLSAtLS1cbiAgICpcbiAgICogV2hlcmUgZDEsIGQyIC0gcHJldmlvdXNseSBvcGVuZWQgZHJhd2Vyc1xuICAgKiBkMSBhbmQgZDIgbXVzdCBiZSBwdXNoZWQgbGVmdCB0byBiZSB2aXNpYmxlIHVuZGVyIGp1c3Qgb3BlbmVkIGQzXG4gICAqL1xuICBwcml2YXRlIF9wdXNoRHJhd2Vyc0Nhc2NhZGUoKSB7XG4gICAgaWYgKHRoaXMuX2RyYXdlclJlZnMuc2l6ZSA+IDEpIHtcbiAgICAgIC8vIFNldFRpbWVvdXQgc2hvdWxkIGJlIGhlcmUgYmVjYXVzZSB3ZSBtdXN0IHdhaXQgcmVuZGVyIG5ld2x5IG9wZW5lZCBkcmF3ZXJcbiAgICAgIC8vIHRvIGJlIGFibGUgdG8gZ2V0IGhpcyB3aWR0aFxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlZnNBcnIgPSBBcnJheS5mcm9tKHRoaXMuX2RyYXdlclJlZnMudmFsdWVzKCkpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSByZWZzQXJyLmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHtcbiAgICAgICAgICBjb25zdCBwcmV2UmVmID0gcmVmc0FycltpIC0gMV07XG4gICAgICAgICAgY29uc3QgY3VyclJlZiA9IHJlZnNBcnJbaV07XG5cbiAgICAgICAgICBwcmV2UmVmLnJlc2l6ZUNvbnRyb2xsZXIucHVzaE1haW5XaWR0aChjdXJyUmVmKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGVPdmVybGF5KCk6IE92ZXJsYXlSZWYge1xuICAgIGNvbnN0IG92ZXJsYXlDb25maWcgPSB0aGlzLl9nZXRPdmVybGF5Q29uZmlnKCk7XG4gICAgcmV0dXJuIHRoaXMuX292ZXJsYXkuY3JlYXRlKG92ZXJsYXlDb25maWcpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0T3ZlcmxheUNvbmZpZygpOiBPdmVybGF5Q29uZmlnIHtcbiAgICByZXR1cm4gbmV3IE92ZXJsYXlDb25maWcoe1xuICAgICAgaGFzQmFja2Ryb3A6IHRydWUsXG4gICAgICBiYWNrZHJvcENsYXNzOiAnZnMtZHJhd2VyLWJhY2tkcm9wJ1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXR0YWNoRHJhd2VyQ29udGFpbmVyPFQsIFI+KFxuICAgIG92ZXJsYXlSZWY6IE92ZXJsYXlSZWYsXG4gICAgZHJhd2VyUmVmOiBEcmF3ZXJSZWY8VCwgUj4sXG4gICAgZGF0YUZhY3Rvcnk6IERyYXdlckRhdGFcbiAgKSB7XG4gICAgY29uc3QgaW5qZWN0b3IgPSB0aGlzLl9jcmVhdGVJbmplY3RvcihkcmF3ZXJSZWYsIGRhdGFGYWN0b3J5KTtcbiAgICBjb25zdCBjb250YWluZXJQb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKEZzRHJhd2VyQ29tcG9uZW50LCB1bmRlZmluZWQsIGluamVjdG9yKTtcbiAgICBjb25zdCBjb250YWluZXJSZWYgPSBvdmVybGF5UmVmLmF0dGFjaDxGc0RyYXdlckNvbXBvbmVudD4oY29udGFpbmVyUG9ydGFsKTtcblxuICAgIHJldHVybiBjb250YWluZXJSZWYuaW5zdGFuY2U7XG4gIH1cblxuICBwcml2YXRlIF9hdHRhY2hDb21wb25lbnQ8VCwgUj4oXG4gICAgY29tcG9uZW50UmVmOiBDb21wb25lbnRUeXBlPFQ+LFxuICAgIGRyYXdlckNvbnRhaW5lcjogRnNEcmF3ZXJDb21wb25lbnQsXG4gICAgZHJhd2VyUmVmOiBEcmF3ZXJSZWY8VCwgUj4sXG4gICAgZGF0YUZhY3Rvcnk6IERyYXdlckRhdGEsXG4gICkge1xuXG4gICAgY29uc3QgaW5qZWN0b3IgPSB0aGlzLl9jcmVhdGVJbmplY3RvcihkcmF3ZXJSZWYsIGRhdGFGYWN0b3J5KTtcblxuICAgIHJldHVybiBkcmF3ZXJDb250YWluZXIuYXR0YWNoQ29tcG9uZW50UG9ydGFsPFQ+KFxuICAgICAgbmV3IENvbXBvbmVudFBvcnRhbDxUPihjb21wb25lbnRSZWYsIHVuZGVmaW5lZCwgaW5qZWN0b3IpXG4gICAgKTtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBfY3JlYXRlSW5qZWN0b3IoY29tcG9uZW50UmVmLCBkYXRhRmFjdG9yeSkge1xuICAgIGNvbnN0IGluamVjdGlvblRva2VucyA9IG5ldyBXZWFrTWFwPGFueSwgYW55PihbXG4gICAgICBbRHJhd2VyUmVmLCBjb21wb25lbnRSZWZdLFxuICAgICAgW0RSQVdFUl9EQVRBLCBkYXRhRmFjdG9yeV1cbiAgICBdKTtcblxuICAgIHJldHVybiBuZXcgUG9ydGFsSW5qZWN0b3IodGhpcy5faW5qZWN0b3IsIGluamVjdGlvblRva2Vucyk7XG4gIH1cblxuXG59XG4iXX0=