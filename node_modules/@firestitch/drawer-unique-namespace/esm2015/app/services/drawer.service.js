import { __decorate, __metadata, __param } from "tslib";
import { Injectable, Injector, OnDestroy, Optional, SkipSelf } from '@angular/core';
import { Overlay, OverlayConfig, OverlayRef } from '@angular/cdk/overlay';
import { ComponentPortal, PortalInjector } from '@angular/cdk/portal';
import { Subject, merge } from 'rxjs';
import { take, takeUntil } from 'rxjs/operators';
import { FsDrawerComponent } from '../components/drawer/drawer.component';
import { DrawerRef } from '../classes/drawer-ref';
import { DrawerData } from '../classes/drawer-data';
import { DRAWER_DATA } from './drawer-data';
let FsDrawerService = class FsDrawerService {
    constructor(_parentDrawerService, _overlay, _injector) {
        this._parentDrawerService = _parentDrawerService;
        this._overlay = _overlay;
        this._injector = _injector;
        this._drawerRefs = new Set();
        this._destroy$ = new Subject();
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
    open(component, config) {
        const overlayRef = this._createOverlay();
        const dataFactory = DrawerData.createWithProxy(config.data);
        const drawerRef = new DrawerRef(overlayRef, dataFactory, config);
        const containerRef = this._attachDrawerContainer(overlayRef, drawerRef, dataFactory);
        const componentRef = this._attachComponent(component, containerRef, drawerRef, dataFactory);
        drawerRef.containerRef = containerRef;
        containerRef.setDrawerRef(drawerRef);
        drawerRef.componentRef = componentRef;
        drawerRef.events();
        drawerRef.open();
        this._storeDrawerRef(drawerRef);
        merge(drawerRef.afterOpened$, drawerRef.afterClosed$)
            .pipe(takeUntil(this._destroy$))
            .subscribe(() => {
            setTimeout(() => {
                this._applyBackdrop();
                this._applyBodyOpenClass();
            });
        });
        return drawerRef;
    }
    closeAll() {
        this._drawerRefs.forEach((ref) => ref.close());
        if (this._parentDrawerService) {
            this._parentDrawerService.closeAll();
        }
    }
    _applyBackdrop() {
        Array.from(this._drawerRefs)
            .forEach((drawerRef, index) => {
            const backdrop = drawerRef.overlayRef.backdropElement;
            if (backdrop) {
                if (index && index === (this._drawerRefs.size - 1)) {
                    backdrop.classList.add('fs-drawer-backdrop-active');
                }
                else {
                    backdrop.classList.remove('fs-drawer-backdrop-active');
                }
            }
        });
    }
    _applyBodyOpenClass() {
        if (this._drawerRefs.size) {
            document.body.classList.add('fs-drawer-open');
        }
        else {
            document.body.classList.remove('fs-drawer-open');
        }
    }
    _storeDrawerRef(ref) {
        this._drawerRefs.add(ref);
        this._pushDrawersCascade();
        ref.destroy$
            .pipe(take(1), takeUntil(this._destroy$))
            .subscribe(() => {
            this._drawerRefs.delete(ref);
        });
    }
    /**
     * In case, when we want to open more than 1 drawer
     * our previously opened drawers should be visible
     *
     *      d1   d2   d3
     *     ---- ---- ---
     *    | x  | x1 | x2
     *    | y  | y1 | y2
     *    | z  | z1 | z2
     *     ---- ---- ---
     *
     * Where d1, d2 - previously opened drawers
     * d1 and d2 must be pushed left to be visible under just opened d3
     */
    _pushDrawersCascade() {
        if (this._drawerRefs.size > 1) {
            // SetTimeout should be here because we must wait render newly opened drawer
            // to be able to get his width
            setTimeout(() => {
                const refsArr = Array.from(this._drawerRefs.values());
                for (let i = refsArr.length - 1; i > 0; i--) {
                    const prevRef = refsArr[i - 1];
                    const currRef = refsArr[i];
                    prevRef.resizeController.pushMainWidth(currRef);
                }
            });
        }
    }
    _createOverlay() {
        const overlayConfig = this._getOverlayConfig();
        return this._overlay.create(overlayConfig);
    }
    _getOverlayConfig() {
        return new OverlayConfig({
            hasBackdrop: true,
            backdropClass: 'fs-drawer-backdrop'
        });
    }
    _attachDrawerContainer(overlayRef, drawerRef, dataFactory) {
        const injector = this._createInjector(drawerRef, dataFactory);
        const containerPortal = new ComponentPortal(FsDrawerComponent, undefined, injector);
        const containerRef = overlayRef.attach(containerPortal);
        return containerRef.instance;
    }
    _attachComponent(componentRef, drawerContainer, drawerRef, dataFactory) {
        const injector = this._createInjector(drawerRef, dataFactory);
        return drawerContainer.attachComponentPortal(new ComponentPortal(componentRef, undefined, injector));
    }
    _createInjector(componentRef, dataFactory) {
        const injectionTokens = new WeakMap([
            [DrawerRef, componentRef],
            [DRAWER_DATA, dataFactory]
        ]);
        return new PortalInjector(this._injector, injectionTokens);
    }
};
FsDrawerService.ctorParameters = () => [
    { type: FsDrawerService, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: Overlay },
    { type: Injector }
];
FsDrawerService = __decorate([
    Injectable(),
    __param(0, Optional()), __param(0, SkipSelf()),
    __metadata("design:paramtypes", [FsDrawerService,
        Overlay,
        Injector])
], FsDrawerService);
export { FsDrawerService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmlyZXN0aXRjaC9kcmF3ZXIvIiwic291cmNlcyI6WyJhcHAvc2VydmljZXMvZHJhd2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQWlCLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXJGLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFTLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVwRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTVDLElBQWEsZUFBZSxHQUE1QixNQUFhLGVBQWU7SUFLMUIsWUFDa0Msb0JBQXFDLEVBQzdELFFBQWlCLEVBQ2pCLFNBQW1CO1FBRksseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFpQjtRQUM3RCxhQUFRLEdBQVIsUUFBUSxDQUFTO1FBQ2pCLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFOckIsZ0JBQVcsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztRQUN4QyxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQU1sQyxDQUFDO0lBRU0sV0FBVztRQUNoQixJQUFJLENBQUMsU0FBUyxDQUFD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SCxPQUFPO1lBQ04sUUFBUTs7QUFSbEIsZUFBZTtJQUQzQixVQUFVLEVBQUU7SUFPUixXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxRQUFRLEVBQUUsQ0FBQTtxQ0FBK0IsZUFBZTtRQUNuRCxPQUFPO1FBQ04sUUFBUTtHQVJsQixlQUFlLENBa0wzQjtTQWxMWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9uRGVzdHJveSwgT3B0aW9uYWwsIFNraXBTZWxmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPdmVybGF5LCBPdmVybGF5Q29uZmlnLCBPdmVybGF5UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsLCBDb21wb25lbnRUeXBlLCBQb3J0YWxJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuXG5pbXBvcnQgeyBTdWJqZWN0LCBtZXJnZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZSwgdGFrZVVudGlsLCBkZWxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgRnNEcmF3ZXJDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL2RyYXdlci9kcmF3ZXIuY29tcG9uZW50JztcbmltcG9ydCB7IERyYXdlclJlZiB9IGZyb20gJy4uL2NsYXNzZXMvZHJhd2VyLXJlZic7XG5pbXBvcnQgeyBEcmF3ZXJEYXRhIH0gZnJvbSAnLi4vY2xhc3Nlcy9kcmF3ZXItZGF0YSc7XG5pbXBvcnQgeyBJRHJhd2VyQ29uZmlnIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9kcmF3ZXItY29uZmlnLmludGVyZmFjZSc7XG5pbXBvcnQgeyBEUkFXRVJfREFUQSB9IGZyb20gJy4vZHJhd2VyLWRhdGEnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGc0RyYXdlclNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuXG4gIHByaXZhdGUgX2RyYXdlclJlZnMgPSBuZXcgU2V0PERyYXdlclJlZjxhbnk+PigpO1xuICBwcml2YXRlIF9kZXN0cm95JCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKCkgQFNraXBTZWxmKCkgcHJpdmF0ZSBfcGFyZW50RHJhd2VyU2VydmljZTogRnNEcmF3ZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgX292ZXJsYXk6IE92ZXJsYXksXG4gICAgcHJpdmF0ZSBfaW5qZWN0b3I6IEluamVjdG9yKSB7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fZGVzdHJveSQubmV4dCgpO1xuICAgIHRoaXMuX2Rlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgb3BlbjxURGF0YSA9IGFueT4oY29tcG9uZW50OiBDb21wb25lbnRUeXBlPGFueT4sIGNvbmZpZz86IElEcmF3ZXJDb25maWc8VERhdGE+KSB7XG4gICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMuX2NyZWF0ZU92ZXJsYXkoKTtcblxuICAgIGNvbnN0IGRhdGFGYWN0b3J5ID0gRHJhd2VyRGF0YS5jcmVhdGVXaXRoUHJveHkoY29uZmlnLmRhdGEpO1xuICAgIGNvbnN0IGRyYXdlclJlZiA9IG5ldyBEcmF3ZXJSZWYob3ZlcmxheVJlZiwgZGF0YUZhY3RvcnksIGNvbmZpZyk7XG5cbiAgICBjb25zdCBjb250YWluZXJSZWYgPSB0aGlzLl9hdHRhY2hEcmF3ZXJDb250YWluZXIob3ZlcmxheVJlZiwgZHJhd2VyUmVmLCBkYXRhRmFjdG9yeSk7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5fYXR0YWNoQ29tcG9uZW50KGNvbXBvbmVudCwgY29udGFpbmVyUmVmLCBkcmF3ZXJSZWYsIGRhdGFGYWN0b3J5KTtcblxuICAgIGRyYXdlclJlZi5jb250YWluZXJSZWYgPSBjb250YWluZXJSZWY7XG4gICAgY29udGFpbmVyUmVmLnNldERyYXdlclJlZihkcmF3ZXJSZWYpO1xuXG4gICAgZHJhd2VyUmVmLmNvbXBvbmVudFJlZiA9IGNvbXBvbmVudFJlZjtcblxuICAgIGRyYXdlclJlZi5ldmVudHMoKTtcbiAgICBkcmF3ZXJSZWYub3BlbigpO1xuXG4gICAgdGhpcy5fc3RvcmVEcmF3ZXJSZWYoZHJhd2VyUmVmKTtcblxuICAgIG1lcmdlKFxuICAgICAgZHJhd2VyUmVmLmFmdGVyT3BlbmVkJCxcbiAgICAgIGRyYXdlclJlZi5hZnRlckNsb3NlZCRcbiAgICApXG4gICAgLnBpcGUoXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpXG4gICAgKVxuICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuX2FwcGx5QmFja2Ryb3AoKTtcbiAgICAgICAgdGhpcy5fYXBwbHlCb2R5T3BlbkNsYXNzKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiBkcmF3ZXJSZWY7XG4gIH1cblxuICBwdWJsaWMgY2xvc2VBbGwoKSB7XG4gICAgdGhpcy5fZHJhd2VyUmVmcy5mb3JFYWNoKChyZWYpID0+IHJlZi5jbG9zZSgpKTtcblxuICAgIGlmICh0aGlzLl9wYXJlbnREcmF3ZXJTZXJ2aWNlKSB7XG4gICAgICB0aGlzLl9wYXJlbnREcmF3ZXJTZXJ2aWNlLmNsb3NlQWxsKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlCYWNrZHJvcCgpIHtcbiAgICBBcnJheS5mcm9tKHRoaXMuX2RyYXdlclJlZnMpXG4gICAgLmZvckVhY2goKGRyYXdlclJlZiwgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGJhY2tkcm9wID0gZHJhd2VyUmVmLm92ZXJsYXlSZWYuYmFja2Ryb3BFbGVtZW50O1xuXG4gICAgICBpZiAoYmFja2Ryb3ApIHtcbiAgICAgICAgaWYgKGluZGV4ICYmIGluZGV4ID09PSAodGhpcy5fZHJhd2VyUmVmcy5zaXplIC0gMSkpIHtcbiAgICAgICAgICBiYWNrZHJvcC5jbGFzc0xpc3QuYWRkKCdmcy1kcmF3ZXItYmFja2Ryb3AtYWN0aXZlJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYmFja2Ryb3AuY2xhc3NMaXN0LnJlbW92ZSgnZnMtZHJhd2VyLWJhY2tkcm9wLWFjdGl2ZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9hcHBseUJvZHlPcGVuQ2xhc3MoKSB7XG4gICAgaWYgKHRoaXMuX2RyYXdlclJlZnMuc2l6ZSkge1xuICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdmcy1kcmF3ZXItb3BlbicpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2ZzLWRyYXdlci1vcGVuJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfc3RvcmVEcmF3ZXJSZWYocmVmKSB7XG4gICAgdGhpcy5fZHJhd2VyUmVmcy5hZGQocmVmKTtcblxuICAgIHRoaXMuX3B1c2hEcmF3ZXJzQ2FzY2FkZSgpO1xuXG4gICAgcmVmLmRlc3Ryb3kkXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLl9kcmF3ZXJSZWZzLmRlbGV0ZShyZWYpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogSW4gY2FzZSwgd2hlbiB3ZSB3YW50IHRvIG9wZW4gbW9yZSB0aGFuIDEgZHJhd2VyXG4gICAqIG91ciBwcmV2aW91c2x5IG9wZW5lZCBkcmF3ZXJzIHNob3VsZCBiZSB2aXNpYmxlXG4gICAqXG4gICAqICAgICAgZDEgICBkMiAgIGQzXG4gICAqICAgICAtLS0tIC0tLS0gLS0tXG4gICAqICAgIHwgeCAgfCB4MSB8IHgyXG4gICAqICAgIHwgeSAgfCB5MSB8IHkyXG4gICAqICAgIHwgeiAgfCB6MSB8IHoyXG4gICAqICAgICAtLS0tIC0tLS0gLS0tXG4gICAqXG4gICAqIFdoZXJlIGQxLCBkMiAtIHByZXZpb3VzbHkgb3BlbmVkIGRyYXdlcnNcbiAgICogZDEgYW5kIGQyIG11c3QgYmUgcHVzaGVkIGxlZnQgdG8gYmUgdmlzaWJsZSB1bmRlciBqdXN0IG9wZW5lZCBkM1xuICAgKi9cbiAgcHJpdmF0ZSBfcHVzaERyYXdlcnNDYXNjYWRlKCkge1xuICAgIGlmICh0aGlzLl9kcmF3ZXJSZWZzLnNpemUgPiAxKSB7XG4gICAgICAvLyBTZXRUaW1lb3V0IHNob3VsZCBiZSBoZXJlIGJlY2F1c2Ugd2UgbXVzdCB3YWl0IHJlbmRlciBuZXdseSBvcGVuZWQgZHJhd2VyXG4gICAgICAvLyB0byBiZSBhYmxlIHRvIGdldCBoaXMgd2lkdGhcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25zdCByZWZzQXJyID0gQXJyYXkuZnJvbSh0aGlzLl9kcmF3ZXJSZWZzLnZhbHVlcygpKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gcmVmc0Fyci5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7XG4gICAgICAgICAgY29uc3QgcHJldlJlZiA9IHJlZnNBcnJbaSAtIDFdO1xuICAgICAgICAgIGNvbnN0IGN1cnJSZWYgPSByZWZzQXJyW2ldO1xuXG4gICAgICAgICAgcHJldlJlZi5yZXNpemVDb250cm9sbGVyLnB1c2hNYWluV2lkdGgoY3VyclJlZik7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfY3JlYXRlT3ZlcmxheSgpOiBPdmVybGF5UmVmIHtcbiAgICBjb25zdCBvdmVybGF5Q29uZmlnID0gdGhpcy5fZ2V0T3ZlcmxheUNvbmZpZygpO1xuICAgIHJldHVybiB0aGlzLl9vdmVybGF5LmNyZWF0ZShvdmVybGF5Q29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldE92ZXJsYXlDb25maWcoKTogT3ZlcmxheUNvbmZpZyB7XG4gICAgcmV0dXJuIG5ldyBPdmVybGF5Q29uZmlnKHtcbiAgICAgIGhhc0JhY2tkcm9wOiB0cnVlLFxuICAgICAgYmFja2Ryb3BDbGFzczogJ2ZzLWRyYXdlci1iYWNrZHJvcCdcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2F0dGFjaERyYXdlckNvbnRhaW5lcjxULCBSPihcbiAgICBvdmVybGF5UmVmOiBPdmVybGF5UmVmLFxuICAgIGRyYXdlclJlZjogRHJhd2VyUmVmPFQsIFI+LFxuICAgIGRhdGFGYWN0b3J5OiBEcmF3ZXJEYXRhXG4gICkge1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IoZHJhd2VyUmVmLCBkYXRhRmFjdG9yeSk7XG4gICAgY29uc3QgY29udGFpbmVyUG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChGc0RyYXdlckNvbXBvbmVudCwgdW5kZWZpbmVkLCBpbmplY3Rvcik7XG4gICAgY29uc3QgY29udGFpbmVyUmVmID0gb3ZlcmxheVJlZi5hdHRhY2g8RnNEcmF3ZXJDb21wb25lbnQ+KGNvbnRhaW5lclBvcnRhbCk7XG5cbiAgICByZXR1cm4gY29udGFpbmVyUmVmLmluc3RhbmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXR0YWNoQ29tcG9uZW50PFQsIFI+KFxuICAgIGNvbXBvbmVudFJlZjogQ29tcG9uZW50VHlwZTxUPixcbiAgICBkcmF3ZXJDb250YWluZXI6IEZzRHJhd2VyQ29tcG9uZW50LFxuICAgIGRyYXdlclJlZjogRHJhd2VyUmVmPFQsIFI+LFxuICAgIGRhdGFGYWN0b3J5OiBEcmF3ZXJEYXRhLFxuICApIHtcblxuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IoZHJhd2VyUmVmLCBkYXRhRmFjdG9yeSk7XG5cbiAgICByZXR1cm4gZHJhd2VyQ29udGFpbmVyLmF0dGFjaENvbXBvbmVudFBvcnRhbDxUPihcbiAgICAgIG5ldyBDb21wb25lbnRQb3J0YWw8VD4oY29tcG9uZW50UmVmLCB1bmRlZmluZWQsIGluamVjdG9yKVxuICAgICk7XG4gIH1cblxuXG4gIHByaXZhdGUgX2NyZWF0ZUluamVjdG9yKGNvbXBvbmVudFJlZiwgZGF0YUZhY3RvcnkpIHtcbiAgICBjb25zdCBpbmplY3Rpb25Ub2tlbnMgPSBuZXcgV2Vha01hcDxhbnksIGFueT4oW1xuICAgICAgW0RyYXdlclJlZiwgY29tcG9uZW50UmVmXSxcbiAgICAgIFtEUkFXRVJfREFUQSwgZGF0YUZhY3RvcnldXG4gICAgXSk7XG5cbiAgICByZXR1cm4gbmV3IFBvcnRhbEluamVjdG9yKHRoaXMuX2luamVjdG9yLCBpbmplY3Rpb25Ub2tlbnMpO1xuICB9XG5cblxufVxuIl19