import { ESCAPE } from '@angular/cdk/keycodes';
import { BehaviorSubject, Observable, Subject, zip } from 'rxjs';
import { filter, take, takeUntil } from 'rxjs/operators';
import { DrawerConfig } from '../models/drawer-config.model';
export class DrawerRef {
    constructor(_overlayRef, _dataFactory, _config) {
        this._overlayRef = _overlayRef;
        this._dataFactory = _dataFactory;
        /** Subject for notifying the user that the drawer has finished opening. */
        this._afterOpened$ = new Subject();
        /** Subject for notifying the user that the drawer has finished closing. */
        this._afterClosed$ = new Subject();
        /** Subject for notifying the user that the drawer has started closing. */
        this._closeStart$ = new Subject();
        /** Subject for notifying the user that the drawer has started opening. */
        this._openStart$ = new Subject();
        /** Subject for notifying the user that the drawer has started closing. */
        this._sideToggle = new Subject();
        /** Subject for notifying the user that the drawer has finished opening. */
        this._actionsUpdated$ = new Subject();
        /** Destroy notifier **/
        this._destroy$ = new Subject();
        this._activeAction = new BehaviorSubject(void 0);
        this._menuRefs = new Map();
        this._isOpen = false;
        this._isSideOpen = false;
        this.drawerConfig = new DrawerConfig(_config);
        this._activeAction.next(this.drawerConfig.activeAction);
    }
    get overlayRef() {
        return this._overlayRef;
    }
    /**
     * Getter for DRAWER_DATA for current drawer
     */
    get drawerData() {
        return Object.assign({}, this._dataFactory.getValue()); // Like immutable.... TODO switch to Immer
    }
    get destroy$() {
        return this._destroy$.asObservable();
    }
    /**
     * Set reference to drawer container
     * @param value
     */
    set containerRef(value) {
        this._drawerContainerRef = value;
    }
    /**
     * Set reference to drawer component
     * @param value
     */
    set componentRef(value) {
        this._drawerComponentRef = value;
    }
    set drawerContentContainer(value) {
        this._drawerContentContainer = value;
    }
    set drawerActionsContainer(value) {
        this._drawerActionsContainer = value;
    }
    get drawerContentContainer() {
        return this._drawerContentContainer;
    }
    get drawerActionsContainer() {
        return this._drawerActionsContainer;
    }
    get activeAction() {
        return this._activeAction.getValue();
    }
    get activeAction$() {
        return this._activeAction.pipe(takeUntil(this._destroy$));
    }
    /**
     * Return actual status of the drawer
     */
    get isOpen() {
        return this._isOpen;
    }
    /**
     * Return actual status of the side of the drawer
     */
    get isSideOpen() {
        return this._isSideOpen;
    }
    set resizeController(value) {
        this._resizeController = value;
    }
    get resizeController() {
        return this._resizeController;
    }
    /**
     * Gets an observable that action was updated and change detection should be started
     */
    get actionUpdated$() {
        return this._actionsUpdated$.pipe(takeUntil(this._destroy$));
    }
    /**
     * Gets an observable that is notified when the dialog is finished closing.
     */
    get afterClosed$() {
        return this._afterClosed$.pipe(takeUntil(this._destroy$));
    }
    /**
     * Gets an observable that is notified when the dialog is finished opening.
     */
    get afterOpened$() {
        return this._afterOpened$.pipe(takeUntil(this._destroy$));
    }
    /**
     * Gets an observable that is notified when the dialog open starts.
     */
    get openStart$() {
        return this._openStart$.pipe(takeUntil(this._destroy$));
    }
    /**
     * Gets an observable that is notified when the dialog is finished opening.
     */
    get closeStart$() {
        return this._closeStart$.pipe(takeUntil(this._destroy$));
    }
    /**
     * Gets an observable that is notified when data in DRAWER_DATA was changed
     */
    get dataChanged$() {
        return this._dataFactory.dataChange$;
    }
    /**
     * Gets an observable that is notify that side status toggled
     */
    get sideToggle$() {
        return this._sideToggle.pipe(takeUntil(this._destroy$));
    }
    /**
     * Subscribe on keydown events to react on escape
     */
    events() {
        this._overlayRef.keydownEvents()
            .pipe(filter(event => event.keyCode === ESCAPE && !this.drawerConfig.disableClose), takeUntil(this._destroy$))
            .subscribe(() => this.close());
    }
    /**
     * Set value for DRAWER_DATA
     * @param data
     */
    dataChange(data) {
        this._dataFactory.setValue(data);
    }
    /**
     * Open drawer and notify observable
     */
    open() {
        new Observable((obs) => {
            setTimeout(() => {
                if (this._openStart$.observers.length) {
                    this._openStart$.next(obs);
                }
                else {
                    obs.next();
                    obs.complete();
                }
            });
        }).pipe(takeUntil(this._destroy$))
            .subscribe({
            next: () => {
                if (this.activeAction) {
                    this.openSide();
                }
                this._drawerContainerRef.open();
                this._afterOpened$.next();
                this._afterOpened$.complete();
            },
            error: () => {
                this.destroy();
            },
        });
    }
    /**
     * Close the drawer.
     * @param result Optional result to return to the dialog opener.
     */
    close(result) {
        new Observable(observer => {
            if (this._closeStart$.observers.length) {
                zip(...this._closeStart$.observers.map(item => {
                    return Observable.create(closeObserver => {
                        item.next(closeObserver);
                    });
                }))
                    .pipe(takeUntil(this._destroy$))
                    .subscribe(() => {
                    observer.next();
                    observer.complete();
                }, () => {
                    observer.error();
                });
            }
            else {
                observer.next();
                observer.complete();
            }
        }).pipe(takeUntil(this._destroy$))
            .subscribe({
            next: () => {
                this._drawerContainerRef.close();
                this._result = result;
                this._afterClosed$.next(result);
                this.destroy();
            }
        });
    }
    /**
     * Open the side of the drawer
     */
    openSide() {
        this._isSideOpen = true;
        this._sideToggle.next(this._isSideOpen);
    }
    /**
     * Close the side of the drawer
     */
    closeSide() {
        this._isSideOpen = false;
        this._sideToggle.next(this._isSideOpen);
        this.setActiveAction(null);
    }
    /**
     * Toggle the side of the drawer
     */
    toggleSide() {
        this.isSideOpen ? this.closeSide() : this.openSide();
    }
    /**
     * Change active action
     * @param name
     */
    setActiveAction(name) {
        this._activeAction.next(name);
        if (name) {
            this.openSide();
        }
    }
    /**
     * Store opened menu reference and subscribe for auto remove
     * @param name
     * @param ref
     */
    addMenuRef(name, ref) {
        this._menuRefs.set(name, ref);
        ref.afterClosed()
            .pipe(take(1), takeUntil(this._destroy$))
            .subscribe(() => {
            this._menuRefs.delete(name);
        });
    }
    /**
     * Get opened menu reference by name
     * @param name
     */
    getMenuRef(name) {
        return this._menuRefs.get(name);
    }
    getAction(name) {
        return this.drawerConfig.actions.find((action) => action.name === name);
    }
    /**
     * Do update for icon for target action
     * @param name
     * @param icon
     */
    updateActionIcon(name, icon) {
        const action = this.getAction(name);
        if (action) {
            action.icon = icon;
            this._actionsUpdated$.next(name);
        }
    }
    /**
     * Do update
     * @param name
     * @param data
     */
    updateAction(name, data) {
        const action = this.getAction(name);
        if (action) {
            const allowedFields = ['icon', 'type', 'toggle', 'tooltip', 'close', 'closeSide', 'component', 'data'];
            const forUpdate = Object.keys(data).filter((key) => allowedFields.indexOf(key) > -1);
            forUpdate.forEach((key) => {
                action[key] = data[key];
            });
            this._actionsUpdated$.next(name);
        }
    }
    updateDrawerWidth(width) {
        this.resizeController.updateMainWidth(width);
    }
    updateSideDrawerWidth(width) {
        this.resizeController.updateSideWidth(width);
    }
    destroy() {
        this._overlayRef.detachBackdrop();
        this._overlayRef.detach();
        this._drawerComponentRef.destroy();
        this._dataFactory.destroy();
        this._destroy$.next();
        this._destroy$.complete();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd2VyLXJlZi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmaXJlc3RpdGNoL2RyYXdlci8iLCJzb3VyY2VzIjpbImFwcC9jbGFzc2VzL2RyYXdlci1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRy9DLE9BQU8sRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBYyxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJekQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBTTdELE1BQU0sT0FBTyxTQUFTO0lBa0RwQixZQUNVLFdBQXVCLEVBQ3ZCLFlBQXdCLEVBQ2hDLE9BQXNCO1FBRmQsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFDdkIsaUJBQVksR0FBWixZQUFZLENBQVk7UUFoRGxDLDJFQUEyRTtRQUMxRCxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFFckQsMkVBQTJFO1FBQzFELGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQWlCLENBQUM7UUFFOUQsMEVBQTBFO1FBQ3pELGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQW9CLENBQUM7UUFFaEUsMEVBQTBFO1FBQ3pELGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQW9CLENBQUM7UUFFL0QsMEVBQTBFO1FBQ3pELGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUV0RCwyRUFBMkU7UUFDMUQscUJBQWdCLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUUxRCx3QkFBd0I7UUFDUCxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQW1CekMsa0JBQWEsR0FBRyxJQUFJLGVBQWUsQ0FBUyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXBELGNBQVMsR0FBRyxJQUFJ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TUFBTSxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFNUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzVCLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRVNDQVBFIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2tleWNvZGVzJztcbmltcG9ydCB7IE92ZXJsYXlSZWYgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5cbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgU3Vic2NyaWJlciwgemlwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHRha2UsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgRHJhd2VyRGF0YSB9IGZyb20gJy4vZHJhd2VyLWRhdGEnO1xuaW1wb3J0IHsgRnNEcmF3ZXJDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL2RyYXdlci9kcmF3ZXIuY29tcG9uZW50JztcbmltcG9ydCB7IERyYXdlckNvbmZpZyB9IGZyb20gJy4uL21vZGVscy9kcmF3ZXItY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IERyYXdlck1lbnVSZWYgfSBmcm9tICcuLi9jbGFzc2VzL2RyYXdlci1tZW51LXJlZic7XG5pbXBvcnQgeyBJRHJhd2VyQ29uZmlnIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9kcmF3ZXItY29uZmlnLmludGVyZmFjZSc7XG5pbXBvcnQgeyBEcmF3ZXJTaXplQ29udHJvbGxlciB9IGZyb20gJy4vZHJhd2VyLXNpemUtY29udHJvbGxlcic7XG5cblxuZXhwb3J0IGNsYXNzIERyYXdlclJlZjxULCBSID0gYW55PiB7XG5cbiAgcHVibGljIHJlYWRvbmx5IGRyYXdlckNvbmZpZzogRHJhd2VyQ29uZmlnO1xuXG4gIC8qKiBTdWJqZWN0IGZvciBub3RpZnlpbmcgdGhlIHVzZXIgdGhhdCB0aGUgZHJhd2VyIGhhcyBmaW5pc2hlZCBvcGVuaW5nLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9hZnRlck9wZW5lZCQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIC8qKiBTdWJqZWN0IGZvciBub3RpZnlpbmcgdGhlIHVzZXIgdGhhdCB0aGUgZHJhd2VyIGhhcyBmaW5pc2hlZCBjbG9zaW5nLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9hZnRlckNsb3NlZCQgPSBuZXcgU3ViamVjdDxSIHwgdW5kZWZpbmVkPigpO1xuXG4gIC8qKiBTdWJqZWN0IGZvciBub3RpZnlpbmcgdGhlIHVzZXIgdGhhdCB0aGUgZHJhd2VyIGhhcyBzdGFydGVkIGNsb3NpbmcuICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX2Nsb3NlU3RhcnQkID0gbmV3IFN1YmplY3Q8U3Vic2NyaWJlcjx2b2lkPj4oKTtcblxuICAvKiogU3ViamVjdCBmb3Igbm90aWZ5aW5nIHRoZSB1c2VyIHRoYXQgdGhlIGRyYXdlciBoYXMgc3RhcnRlZCBvcGVuaW5nLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9vcGVuU3RhcnQkID0gbmV3IFN1YmplY3Q8U3Vic2NyaWJlcjx2b2lkPj4oKTtcblxuICAvKiogU3ViamVjdCBmb3Igbm90aWZ5aW5nIHRoZSB1c2VyIHRoYXQgdGhlIGRyYXdlciBoYXMgc3RhcnRlZCBjbG9zaW5nLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9zaWRlVG9nZ2xlID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICAvKiogU3ViamVjdCBmb3Igbm90aWZ5aW5nIHRoZSB1c2VyIHRoYXQgdGhlIGRyYXdlciBoYXMgZmluaXNoZWQgb3BlbmluZy4gKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfYWN0aW9uc1VwZGF0ZWQkID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xuXG4gIC8qKiBEZXN0cm95IG5vdGlmaWVyICoqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgLyoqIFJlc3VsdCB0byBiZSBwYXNzZWQgdG8gYWZ0ZXJDbG9zZWQuICovXG4gIHByaXZhdGUgX3Jlc3VsdDogUiB8IHVuZGVmaW5lZDtcblxuICAvKiogTWFpbiBkcmF3ZXIgY29tcG9uZW50IGFuZCB0ZW1wbGF0ZSAqL1xuICBwcml2YXRlIF9kcmF3ZXJDb250YWluZXJSZWY6IEZzRHJhd2VyQ29tcG9uZW50O1xuXG4gIC8qKiBNYWluIGRyYXdlciBjb21wb25lbnQgYW5kIHRlbXBsYXRlICovXG4gIHByaXZhdGUgX2RyYXdlckNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPFQ+O1xuXG4gIC8qKiBEcmF3ZXIgQ29udGVudCBUZW1wbGF0ZSAqL1xuICBwcml2YXRlIF9kcmF3ZXJDb250ZW50Q29udGFpbmVyOiBFbGVtZW50UmVmO1xuXG4gIC8qKiBEcmF3ZXIgQWN0aW9ucyBUZW1wbGF0ZSAqL1xuICBwcml2YXRlIF9kcmF3ZXJBY3Rpb25zQ29udGFpbmVyOiBFbGVtZW50UmVmO1xuXG4gIHByaXZhdGUgX3Jlc2l6ZUNvbnRyb2xsZXI6IERyYXdlclNpemVDb250cm9sbGVyO1xuXG4gIHByaXZhdGUgX2FjdGl2ZUFjdGlvbiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPih2b2lkIDApO1xuXG4gIHByaXZhdGUgX21lbnVSZWZzID0gbmV3IE1hcDxzdHJpbmcsIERyYXdlck1lbnVSZWY8VCwgUj4+KCk7XG5cbiAgcHJpdmF0ZSBfaXNPcGVuID0gZmFsc2U7XG4gIHByaXZhdGUgX2lzU2lkZU9wZW4gPSBmYWxzZTtcblxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX292ZXJsYXlSZWY6IE92ZXJsYXlSZWYsXG4gICAgcHJpdmF0ZSBfZGF0YUZhY3Rvcnk6IERyYXdlckRhdGEsXG4gICAgX2NvbmZpZzogSURyYXdlckNvbmZpZ1xuICApIHtcbiAgICB0aGlzLmRyYXdlckNvbmZpZyA9IG5ldyBEcmF3ZXJDb25maWcoX2NvbmZpZyk7XG4gICAgdGhpcy5fYWN0aXZlQWN0aW9uLm5leHQodGhpcy5kcmF3ZXJDb25maWcuYWN0aXZlQWN0aW9uKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgb3ZlcmxheVJlZigpIHtcbiAgICByZXR1cm4gdGhpcy5fb3ZlcmxheVJlZjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXR0ZXIgZm9yIERSQVdFUl9EQVRBIGZvciBjdXJyZW50IGRyYXdlclxuICAgKi9cbiAgcHVibGljIGdldCBkcmF3ZXJEYXRhKCkge1xuICAgIHJldHVybiB7IC4uLnRoaXMuX2RhdGFGYWN0b3J5LmdldFZhbHVlKCkgfSAvLyBMaWtlIGltbXV0YWJsZS4uLi4gVE9ETyBzd2l0Y2ggdG8gSW1tZXJcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGVzdHJveSQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Rlc3Ryb3kkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCByZWZlcmVuY2UgdG8gZHJhd2VyIGNvbnRhaW5lclxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICovXG4gIHB1YmxpYyBzZXQgY29udGFpbmVyUmVmKHZhbHVlOiBGc0RyYXdlckNvbXBvbmVudCkge1xuICAgIHRoaXMuX2RyYXdlckNvbnRhaW5lclJlZiA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCByZWZlcmVuY2UgdG8gZHJhd2VyIGNvbXBvbmVudFxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICovXG4gIHB1YmxpYyBzZXQgY29tcG9uZW50UmVmKHZhbHVlOiBDb21wb25lbnRSZWY8VD4pIHtcbiAgICB0aGlzLl9kcmF3ZXJDb21wb25lbnRSZWYgPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgZHJhd2VyQ29udGVudENvbnRhaW5lcih2YWx1ZTogRWxlbWVudFJlZikge1xuICAgIHRoaXMuX2RyYXdlckNvbnRlbnRDb250YWluZXIgPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgZHJhd2VyQWN0aW9uc0NvbnRhaW5lcih2YWx1ZTogRWxlbWVudFJlZikge1xuICAgIHRoaXMuX2RyYXdlckFjdGlvbnNDb250YWluZXIgPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZHJhd2VyQ29udGVudENvbnRhaW5lcigpOiBFbGVtZW50UmVmIHtcbiAgICByZXR1cm4gdGhpcy5fZHJhd2VyQ29udGVudENvbnRhaW5lcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZHJhd2VyQWN0aW9uc0NvbnRhaW5lcigpOiBFbGVtZW50UmVmIHtcbiAgICByZXR1cm4gdGhpcy5fZHJhd2VyQWN0aW9uc0NvbnRhaW5lcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYWN0aXZlQWN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLl9hY3RpdmVBY3Rpb24uZ2V0VmFsdWUoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYWN0aXZlQWN0aW9uJCgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlQWN0aW9uLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGFjdHVhbCBzdGF0dXMgb2YgdGhlIGRyYXdlclxuICAgKi9cbiAgcHVibGljIGdldCBpc09wZW4oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2lzT3BlbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYWN0dWFsIHN0YXR1cyBvZiB0aGUgc2lkZSBvZiB0aGUgZHJhd2VyXG4gICAqL1xuICBwdWJsaWMgZ2V0IGlzU2lkZU9wZW4oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2lzU2lkZU9wZW47XG4gIH1cblxuICBwdWJsaWMgc2V0IHJlc2l6ZUNvbnRyb2xsZXIodmFsdWU6IERyYXdlclNpemVDb250cm9sbGVyKSB7XG4gICAgdGhpcy5fcmVzaXplQ29udHJvbGxlciA9IHZhbHVlO1xuICB9XG5cbiAgcHVibGljIGdldCByZXNpemVDb250cm9sbGVyKCk6IERyYXdlclNpemVDb250cm9sbGVyIHtcbiAgICByZXR1cm4gdGhpcy5fcmVzaXplQ29udHJvbGxlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGFuIG9ic2VydmFibGUgdGhhdCBhY3Rpb24gd2FzIHVwZGF0ZWQgYW5kIGNoYW5nZSBkZXRlY3Rpb24gc2hvdWxkIGJlIHN0YXJ0ZWRcbiAgICovXG4gIHB1YmxpYyBnZXQgYWN0aW9uVXBkYXRlZCQoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aW9uc1VwZGF0ZWQkLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbiBvYnNlcnZhYmxlIHRoYXQgaXMgbm90aWZpZWQgd2hlbiB0aGUgZGlhbG9nIGlzIGZpbmlzaGVkIGNsb3NpbmcuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGFmdGVyQ2xvc2VkJCgpOiBPYnNlcnZhYmxlPFIgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5fYWZ0ZXJDbG9zZWQkLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbiBvYnNlcnZhYmxlIHRoYXQgaXMgbm90aWZpZWQgd2hlbiB0aGUgZGlhbG9nIGlzIGZpbmlzaGVkIG9wZW5pbmcuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGFmdGVyT3BlbmVkJCgpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5fYWZ0ZXJPcGVuZWQkLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbiBvYnNlcnZhYmxlIHRoYXQgaXMgbm90aWZpZWQgd2hlbiB0aGUgZGlhbG9nIG9wZW4gc3RhcnRzLlxuICAgKi9cbiAgcHVibGljIGdldCBvcGVuU3RhcnQkKCk6IE9ic2VydmFibGU8U3Vic2NyaWJlcjx2b2lkPj4ge1xuICAgIHJldHVybiB0aGlzLl9vcGVuU3RhcnQkLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbiBvYnNlcnZhYmxlIHRoYXQgaXMgbm90aWZpZWQgd2hlbiB0aGUgZGlhbG9nIGlzIGZpbmlzaGVkIG9wZW5pbmcuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGNsb3NlU3RhcnQkKCk6IE9ic2VydmFibGU8U3Vic2NyaWJlcjx2b2lkPj4ge1xuICAgIHJldHVybiB0aGlzLl9jbG9zZVN0YXJ0JC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYW4gb2JzZXJ2YWJsZSB0aGF0IGlzIG5vdGlmaWVkIHdoZW4gZGF0YSBpbiBEUkFXRVJfREFUQSB3YXMgY2hhbmdlZFxuICAgKi9cbiAgcHVibGljIGdldCBkYXRhQ2hhbmdlZCQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YUZhY3RvcnkuZGF0YUNoYW5nZSQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbiBvYnNlcnZhYmxlIHRoYXQgaXMgbm90aWZ5IHRoYXQgc2lkZSBzdGF0dXMgdG9nZ2xlZFxuICAgKi9cbiAgcHVibGljIGdldCBzaWRlVG9nZ2xlJCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5fc2lkZVRvZ2dsZS5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSBvbiBrZXlkb3duIGV2ZW50cyB0byByZWFjdCBvbiBlc2NhcGVcbiAgICovXG4gIHB1YmxpYyBldmVudHMoKSB7XG4gICAgdGhpcy5fb3ZlcmxheVJlZi5rZXlkb3duRXZlbnRzKClcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoZXZlbnQgPT4gZXZlbnQua2V5Q29kZSA9PT0gRVNDQVBFICYmICF0aGlzLmRyYXdlckNvbmZpZy5kaXNhYmxlQ2xvc2UpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB2YWx1ZSBmb3IgRFJBV0VSX0RBVEFcbiAgICogQHBhcmFtIGRhdGFcbiAgICovXG4gIHB1YmxpYyBkYXRhQ2hhbmdlKGRhdGEpIHtcbiAgICB0aGlzLl9kYXRhRmFjdG9yeS5zZXRWYWx1ZShkYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVuIGRyYXdlciBhbmQgbm90aWZ5IG9ic2VydmFibGVcbiAgICovXG4gIHB1YmxpYyBvcGVuKCkge1xuICAgIG5ldyBPYnNlcnZhYmxlPHZvaWQ+KChvYnMpID0+IHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4geyAvLyBGSVhNRSBDcnV0Y2hcbiAgICAgICAgaWYgKHRoaXMuX29wZW5TdGFydCQub2JzZXJ2ZXJzLmxlbmd0aCkge1xuICAgICAgICAgIHRoaXMuX29wZW5TdGFydCQubmV4dChvYnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG9icy5uZXh0KCk7XG4gICAgICAgICAgb2JzLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuYWN0aXZlQWN0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLm9wZW5TaWRlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5fZHJhd2VyQ29udGFpbmVyUmVmLm9wZW4oKTtcbiAgICAgICAgICB0aGlzLl9hZnRlck9wZW5lZCQubmV4dCgpO1xuICAgICAgICAgIHRoaXMuX2FmdGVyT3BlbmVkJC5jb21wbGV0ZSgpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlIHRoZSBkcmF3ZXIuXG4gICAqIEBwYXJhbSByZXN1bHQgT3B0aW9uYWwgcmVzdWx0IHRvIHJldHVybiB0byB0aGUgZGlhbG9nIG9wZW5lci5cbiAgICovXG4gIHB1YmxpYyBjbG9zZShyZXN1bHQ/OiBSKTogdm9pZCB7XG4gICAgbmV3IE9ic2VydmFibGU8dm9pZD4ob2JzZXJ2ZXIgPT4ge1xuICAgICAgaWYgKHRoaXMuX2Nsb3NlU3RhcnQkLm9ic2VydmVycy5sZW5ndGgpIHtcbiAgICAgICAgemlwKC4uLnRoaXMuX2Nsb3NlU3RhcnQkLm9ic2VydmVycy5tYXAoaXRlbSA9PiB7XG4gICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKGNsb3NlT2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgaXRlbS5uZXh0KGNsb3NlT2JzZXJ2ZXIpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYnNlcnZlci5uZXh0KCk7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9XG5cbiAgICB9KS5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCkpXG4gICAgICAuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6ICgpID0+IHtcbiAgICAgICAgdGhpcy5fZHJhd2VyQ29udGFpbmVyUmVmLmNsb3NlKCk7XG4gICAgICAgIHRoaXMuX3Jlc3VsdCA9IHJlc3VsdDtcbiAgICAgICAgdGhpcy5fYWZ0ZXJDbG9zZWQkLm5leHQocmVzdWx0KTtcbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiB0aGUgc2lkZSBvZiB0aGUgZHJhd2VyXG4gICAqL1xuICBwdWJsaWMgb3BlblNpZGUoKSB7XG4gICAgdGhpcy5faXNTaWRlT3BlbiA9IHRydWU7XG4gICAgdGhpcy5fc2lkZVRvZ2dsZS5uZXh0KHRoaXMuX2lzU2lkZU9wZW4pO1xuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlIHRoZSBzaWRlIG9mIHRoZSBkcmF3ZXJcbiAgICovXG4gIHB1YmxpYyBjbG9zZVNpZGUoKSB7XG4gICAgdGhpcy5faXNTaWRlT3BlbiA9IGZhbHNlO1xuICAgIHRoaXMuX3NpZGVUb2dnbGUubmV4dCh0aGlzLl9pc1NpZGVPcGVuKTtcblxuICAgIHRoaXMuc2V0QWN0aXZlQWN0aW9uKG51bGwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSB0aGUgc2lkZSBvZiB0aGUgZHJhd2VyXG4gICAqL1xuICBwdWJsaWMgdG9nZ2xlU2lkZSgpIHtcbiAgICB0aGlzLmlzU2lkZU9wZW4gPyB0aGlzLmNsb3NlU2lkZSgpIDogdGhpcy5vcGVuU2lkZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoYW5nZSBhY3RpdmUgYWN0aW9uXG4gICAqIEBwYXJhbSBuYW1lXG4gICAqL1xuICBwdWJsaWMgc2V0QWN0aXZlQWN0aW9uKG5hbWU6IHN0cmluZykge1xuICAgIHRoaXMuX2FjdGl2ZUFjdGlvbi5uZXh0KG5hbWUpO1xuXG4gICAgaWYgKG5hbWUpIHtcbiAgICAgIHRoaXMub3BlblNpZGUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RvcmUgb3BlbmVkIG1lbnUgcmVmZXJlbmNlIGFuZCBzdWJzY3JpYmUgZm9yIGF1dG8gcmVtb3ZlXG4gICAqIEBwYXJhbSBuYW1lXG4gICAqIEBwYXJhbSByZWZcbiAgICovXG4gIHB1YmxpYyBhZGRNZW51UmVmKG5hbWU6IHN0cmluZywgcmVmOiBEcmF3ZXJNZW51UmVmPFQsIFI+KSB7XG4gICAgdGhpcy5fbWVudVJlZnMuc2V0KG5hbWUsIHJlZik7XG5cbiAgICByZWYuYWZ0ZXJDbG9zZWQoKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLl9tZW51UmVmcy5kZWxldGUobmFtZSk7XG4gICAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBvcGVuZWQgbWVudSByZWZlcmVuY2UgYnkgbmFtZVxuICAgKiBAcGFyYW0gbmFtZVxuICAgKi9cbiAgcHVibGljIGdldE1lbnVSZWYobmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuX21lbnVSZWZzLmdldChuYW1lKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3Rpb24obmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuZHJhd2VyQ29uZmlnLmFjdGlvbnMuZmluZCgoYWN0aW9uKSA9PiBhY3Rpb24ubmFtZSA9PT0gbmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogRG8gdXBkYXRlIGZvciBpY29uIGZvciB0YXJnZXQgYWN0aW9uXG4gICAqIEBwYXJhbSBuYW1lXG4gICAqIEBwYXJhbSBpY29uXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlQWN0aW9uSWNvbihuYW1lOiBzdHJpbmcsIGljb246IHN0cmluZykge1xuICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuZ2V0QWN0aW9uKG5hbWUpO1xuXG4gICAgaWYgKGFjdGlvbikge1xuICAgICAgYWN0aW9uLmljb24gPSBpY29uO1xuXG4gICAgICB0aGlzLl9hY3Rpb25zVXBkYXRlZCQubmV4dChuYW1lKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRG8gdXBkYXRlXG4gICAqIEBwYXJhbSBuYW1lXG4gICAqIEBwYXJhbSBkYXRhXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlQWN0aW9uKG5hbWU6IHN0cmluZywgZGF0YSkge1xuICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuZ2V0QWN0aW9uKG5hbWUpO1xuXG4gICAgaWYgKGFjdGlvbikge1xuICAgICAgY29uc3QgYWxsb3dlZEZpZWxkcyA9IFsnaWNvbicsICd0eXBlJywgJ3RvZ2dsZScsICd0b29sdGlwJywgJ2Nsb3NlJywgJ2Nsb3NlU2lkZScsICdjb21wb25lbnQnLCAnZGF0YSddO1xuXG4gICAgICBjb25zdCBmb3JVcGRhdGUgPSBPYmplY3Qua2V5cyhkYXRhKS5maWx0ZXIoKGtleSkgPT4gYWxsb3dlZEZpZWxkcy5pbmRleE9mKGtleSkgPiAtMSk7XG5cbiAgICAgIGZvclVwZGF0ZS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgYWN0aW9uW2tleV0gPSBkYXRhW2tleV07XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5fYWN0aW9uc1VwZGF0ZWQkLm5leHQobmFtZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZURyYXdlcldpZHRoKHdpZHRoOiBudW1iZXIpIHtcbiAgICB0aGlzLnJlc2l6ZUNvbnRyb2xsZXIudXBkYXRlTWFpbldpZHRoKHdpZHRoKTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVTaWRlRHJhd2VyV2lkdGgod2lkdGg6IG51bWJlcikge1xuICAgIHRoaXMucmVzaXplQ29udHJvbGxlci51cGRhdGVTaWRlV2lkdGgod2lkdGgpO1xuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5fb3ZlcmxheVJlZi5kZXRhY2hCYWNrZHJvcCgpO1xuICAgIHRoaXMuX292ZXJsYXlSZWYuZGV0YWNoKCk7XG4gICAgdGhpcy5fZHJhd2VyQ29tcG9uZW50UmVmLmRlc3Ryb3koKTtcbiAgICB0aGlzLl9kYXRhRmFjdG9yeS5kZXN0cm95KCk7XG5cbiAgICB0aGlzLl9kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG59XG5cbiJdfQ==