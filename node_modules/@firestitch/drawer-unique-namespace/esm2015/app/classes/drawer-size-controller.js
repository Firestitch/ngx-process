import { __decorate, __metadata } from "tslib";
import { Injectable, NgZone, OnDestroy } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, takeUntil } from 'rxjs/operators';
import { DrawerRef } from '../classes/drawer-ref';
const MAIN_DRAWER_DEFAULT_WIDTH = 500;
const SIDE_DRAWER_DEFAULT_WIDTH = 200;
const SIDE_RESIZE_BAR_WIDTH = 25;
const MAIN_RESIZE_ACTION_BAR_WIDTH = 40;
let DrawerSizeController = class DrawerSizeController {
    constructor(_drawerRef, _ngZone) {
        this._drawerRef = _drawerRef;
        this._ngZone = _ngZone;
        this._sideOpened = false;
        this._borderPadding = 0;
        this._destroy$ = new Subject();
        this._initDefaultConfigs();
        this._updateScreenWidth();
        this._listenWindowResize();
        this._listenSideToggle();
    }
    get mainElRef() {
        return this._mainElRef;
    }
    get sideElRef() {
        return this._sideElRef;
    }
    get mainConfig() {
        return this._mainConfig;
    }
    get sideConfig() {
        return this._sideConfig;
    }
    get screenWidth() {
        return this._screenWidth;
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
    registerElRef(el) {
        if (el.type === 'main') {
            this._registerMainRef(el);
        }
        else if (el.type === 'side') {
            this._registerSideRef(el);
        }
        else {
            throw Error('Unrecognized resize element type');
        }
    }
    getInitialWidth(type) {
        if (type === 'main') {
            return this.mainConfig.initial;
        }
        else if (type === 'side') {
            return this.sideConfig.initial;
        }
        else {
            return void 0;
        }
    }
    getMinWidth(type) {
        if (type === 'main') {
            return this.mainConfig.min;
        }
        else if (type === 'side') {
            return this.sideConfig.min;
        }
        else {
            return void 0;
        }
    }
    getMaxWidth(type) {
        if (type === 'main') {
            return this.mainConfig.max;
        }
        else if (type === 'side') {
            return this.sideConfig.max;
        }
        else {
            return void 0;
        }
    }
    /**
     * Update width from outside with all calculations to be done
     * @param width
     */
    updateMainWidth(width) {
        const sideWidth = (this.sideElRef && this.sideElRef.width) || 0;
        this.mainElRef.updateWidth(sideWidth + width);
    }
    /**
     * Update width from outside with all calculations to be done
     * @param width
     */
    updateSideWidth(width) {
        if (this.sideElRef) {
            const currentWidth = this.mainElRef.width - this.sideElRef.width;
            this.mainElRef.updateWidth(currentWidth + width);
            this.sideElRef.updateWidth(width);
        }
    }
    /**
     * Push current drawer to be visible under new one opened
     * @param inFrontDrawer
     */
    pushMainWidth(inFrontDrawer) {
        const inFrontDrawerTotalWidth = inFrontDrawer.resizeController.mainElRef.width + MAIN_RESIZE_ACTION_BAR_WIDTH;
        if (this.mainElRef.width <= inFrontDrawerTotalWidth) {
            this.updateMainWidth(inFrontDrawerTotalWidth);
        }
    }
    /**
     * Listen for browser resize and update restrictions
     */
    _listenWindowResize() {
        this._ngZone.runOutsideAngular(() => {
            fromEvent(window, 'resize')
                .pipe(debounceTime(50), takeUntil(this._destroy$))
                .subscribe(() => {
                this._updateScreenWidth();
                this._updateMinMaxStyles();
            });
        });
    }
    /**
     * Copy initial configs or set default values
     */
    _initDefaultConfigs() {
        this._mainConfig =
            (this._drawerRef.drawerConfig.width && this._drawerRef.drawerConfig.width.main)
                || {};
        this._mainConfig.initial = this._mainConfig.initial || MAIN_DRAWER_DEFAULT_WIDTH;
        this._sideConfig =
            (this._drawerRef.drawerConfig.width && this._drawerRef.drawerConfig.width.side)
                || {};
        this._sideConfig.initial = this._sideConfig.initial || SIDE_DRAWER_DEFAULT_WIDTH;
    }
    _registerMainRef(el) {
        this._mainElRef = el;
    }
    _registerSideRef(el) {
        this._sideElRef = el;
    }
    /**
     * Update current window size
     */
    _updateScreenWidth() {
        this._screenWidth = (window.innerWidth - this._borderPadding);
    }
    /**
     * Update min&max css props for containers
     */
    _updateMinMaxStyles() {
        this.mainElRef.setMinMaxStyles();
        if (this.sideElRef) {
            this.sideElRef.setMinMaxStyles();
        }
    }
    _listenSideToggle() {
        this._drawerRef.sideToggle$
            .pipe(takeUntil(this._destroy$))
            .subscribe((opened) => {
            if (this._sideOpened === opened) {
                return;
            }
            this._sideOpened = opened;
            if (opened) {
                const currentWidth = this.mainElRef.width;
                const sideWidth = this.getInitialWidth('side');
                this._mainElRef.updateWidth(currentWidth + sideWidth + SIDE_RESIZE_BAR_WIDTH);
            }
            else {
                const actualSideWidth = this.sideElRef.fsDrawerResizer.getBoundingClientRect().width;
                const mainWidth = this.mainElRef.width - actualSideWidth - SIDE_RESIZE_BAR_WIDTH;
                this._mainElRef.updateWidth(mainWidth);
            }
        });
    }
};
DrawerSizeController.ctorParameters = () => [
    { type: DrawerRef },
    { type: NgZone }
];
DrawerSizeController = __decorate([
    Injectable(),
    __metadata("design:paramtypes", [DrawerRef,
        NgZone])
], DrawerSizeController);
export { DrawerSizeController };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd2VyLXNpemUtY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmaXJlc3RpdGNoL2RyYXdlci8iLCJzb3VyY2VzIjpbImFwcC9jbGFzc2VzL2RyYXdlci1zaXplLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsWUFBWSxFQUFTLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUlsRCxNQUFNLHlCQUF5QixHQUFHLEdBQUcsQ0FBQztBQUN0QyxNQUFNLHlCQUF5QixHQUFHLEdBQUcsQ0FBQztBQUN0QyxNQUFNLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztBQUNqQyxNQUFNLDRCQUE0QixHQUFHLEVBQUUsQ0FBQztBQUd4QyxJQUFhLG9CQUFvQixHQUFqQyxNQUFhLG9CQUFvQjtJQWUvQixZQUNVLFVBQTBCLEVBQzFCLE9BQWU7UUFEZixlQUFVLEdBQVYsVUFBVSxDQUFnQjtRQUMxQixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBVGpCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBR1gsbUJBQWMsR0FBRyxDQUFDLENBQUM7UUFFNUIsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFNdEMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQVcsU0FBUztRQUNsQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDekIsQ0FBQztJQUVELElBQVcsU0FBUztRQUNsQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDekIsQ0FBQztJQUVELElBQVcsVUFBVTtRQUNuQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQVcsVUFBVTtRQUNuQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQVcsV0FBVztRQUNwQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTSxhQUFhLENBQUMsRUFBNEI7UUFDL0MsSUFBSSxFQUFFLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUN0QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDM0I7YUFBTSxJQUFJLEVBQUUsQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO1lBQzdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMzQjthQUFNO1lBQ0wsTUFBTSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtTQUNoRDtJQUNILENBQUM7SUFFTSxlQUFlLENBQUMsSUFBcUI7UUFDMUMsSUFBSSxJQUFJLEtBQUssTUFBTSxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7U0FDaEM7YUFBTSxJQUFJLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDMUIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztTQUNoQzthQUFNO1lBQ0wsT0FBTyxLQUFLLENBQUMsQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQUVNLFdBQVcsQ0FBQyxJQUFxQjtRQUN0QyxJQUFJLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDbkIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztTQUM1QjthQUFNLElBQUksSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUMxQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1NBQzVCO2FBQU07WUFDTCxPQUFPLEtBQUssQ0FBQyxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0lBRU0sV0FBVyxDQUFDLElBQXFCO1FBQ3RDLElBQUksSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUNuQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1NBQzVCO2FBQU0sSUFBSSxJQUFJLEtBQUssTUFBTSxFQUFFO1lBQzFCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7U0FDNUI7YUFBTTtZQUNMLE9BQU8sS0FBSyxDQUFDLENBQUM7U0FDZjtJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSSxlQUFlLENBQUMsS0FBYTtRQUNsQyxNQUFNLFNBQVMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRDs7O09BR0c7SUFDSSxlQUFlLENBQUMsS0FBYTtRQUNsQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7WUFDakUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNJLGFBQWEsQ0FBQyxhQUE2QjtRQUNoRCxNQUFNLHVCQUF1QixHQUFHLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLDRCQUE0QixDQUFDO1FBRTlHLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksdUJBQXVCLEVBQUU7WUFDbkQsSUFBSSxDQUFDLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1NBQy9DO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssbUJBQW1CO1FBQ3pCLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFO1lBQ2xDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDO2lCQUN4QixJQUFJLENBQ0gsWUFBWSxDQUFDLEVBQUUsQ0FBQyxFQUNoQixTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQjtpQkFDQSxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNkLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUMxQixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUM3QixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssbUJBQW1CO1FBQ3pCLElBQUksQ0FBQyxXQUFXO1lBQ2QsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzttQkFDNUUsRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLElBQUkseUJBQXlCLENBQUM7UUFFakYsSUFBSSxDQUFDLFdBQVc7WUFDZCxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO21CQUM1RSxFQUFFLENBQUM7UUFFUixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sSUFBSSx5QkFBeUIsQ0FBQztJQUNuRixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsRUFBNEI7UUFDbkQsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEVBQTRCO1FBQ25ELElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNLLGtCQUFrQjtRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVEOztPQUVHO0lBQ0ssbUJBQW1CO1FBQ3pCLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFakMsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLENBQUM7U0FDbEM7SUFDSCxDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVzthQUN4QixJQUFJLENBQ0gsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FDMUI7YUFDQSxTQUFTLENBQUMsQ0FBQyxNQUFlLEVBQUUsRUFBRTtZQUM3QixJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssTUFBTSxFQUFFO2dCQUMvQixPQUFPO2FBQ1I7WUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQztZQUUxQixJQUFJLE1BQU0sRUFBRTtnQkFDVixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztnQkFDMUMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFFL0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsWUFBWSxHQUFHLFNBQVMsR0FBRyxxQkFBcUIsQ0FBQyxDQUFDO2FBQy9FO2lCQUFNO2dCQUNMLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLHFCQUFxQixFQUFFLENBQUMsS0FBSyxDQUFDO2dCQUNyRixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxlQUFlLEdBQUcscUJBQXFCLENBQUM7Z0JBRWpGLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ3hDO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0NBQ0YsQ0FBQTs7WUFoTXVCLFNBQVM7WUFDWixNQUFNOztBQWpCZCxvQkFBb0I7SUFEaEMsVUFBVSxFQUFFO3FDQWlCVyxTQUFTO1FBQ1osTUFBTTtHQWpCZCxvQkFBb0IsQ0FnTmhDO1NBaE5ZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGZyb21FdmVudCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBkZWxheSwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBEcmF3ZXJSZWYgfSBmcm9tICcuLi9jbGFzc2VzL2RyYXdlci1yZWYnO1xuaW1wb3J0IHsgRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlIH0gZnJvbSAnLi4vZGlyZWN0aXZlcy9kcmF3ZXItcmVzaXplci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgSURyYXdlcldpZHRoRGVmaW5pdGlvbiB9IGZyb20gJy4uL2ludGVyZmFjZXMvZHJhd2VyLWNvbmZpZy5pbnRlcmZhY2UnO1xuXG5jb25zdCBNQUlOX0RSQVdFUl9ERUZBVUxUX1dJRFRIID0gNTAwO1xuY29uc3QgU0lERV9EUkFXRVJfREVGQVVMVF9XSURUSCA9IDIwMDtcbmNvbnN0IFNJREVfUkVTSVpFX0JBUl9XSURUSCA9IDI1O1xuY29uc3QgTUFJTl9SRVNJWkVfQUNUSU9OX0JBUl9XSURUSCA9IDQwO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRHJhd2VyU2l6ZUNvbnRyb2xsZXIgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuXG4gIHByaXZhdGUgX21haW5FbFJlZjogRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlO1xuICBwcml2YXRlIF9zaWRlRWxSZWY6IEZzRHJhd2VyUmVzaXplckRpcmVjdGl2ZTtcblxuICBwcml2YXRlIF9tYWluQ29uZmlnOiBJRHJhd2VyV2lkdGhEZWZpbml0aW9uO1xuICBwcml2YXRlIF9zaWRlQ29uZmlnOiBJRHJhd2VyV2lkdGhEZWZpbml0aW9uO1xuXG4gIHByaXZhdGUgX3NpZGVPcGVuZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfc2NyZWVuV2lkdGg6IG51bWJlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IF9ib3JkZXJQYWRkaW5nID0gMDtcblxuICBwcml2YXRlIF9kZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfZHJhd2VyUmVmOiBEcmF3ZXJSZWY8YW55PixcbiAgICBwcml2YXRlIF9uZ1pvbmU6IE5nWm9uZSxcbiAgKSB7XG4gICAgdGhpcy5faW5pdERlZmF1bHRDb25maWdzKCk7XG4gICAgdGhpcy5fdXBkYXRlU2NyZWVuV2lkdGgoKTtcbiAgICB0aGlzLl9saXN0ZW5XaW5kb3dSZXNpemUoKTtcbiAgICB0aGlzLl9saXN0ZW5TaWRlVG9nZ2xlKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1haW5FbFJlZigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWFpbkVsUmVmO1xuICB9XG5cbiAgcHVibGljIGdldCBzaWRlRWxSZWYoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NpZGVFbFJlZjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbWFpbkNvbmZpZygpOiBJRHJhd2VyV2lkdGhEZWZpbml0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5fbWFpbkNvbmZpZztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc2lkZUNvbmZpZygpOiBJRHJhd2VyV2lkdGhEZWZpbml0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5fc2lkZUNvbmZpZztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc2NyZWVuV2lkdGgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fc2NyZWVuV2lkdGg7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fZGVzdHJveSQubmV4dCgpO1xuICAgIHRoaXMuX2Rlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJFbFJlZihlbDogRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlKSB7XG4gICAgaWYgKGVsLnR5cGUgPT09ICdtYWluJykge1xuICAgICAgdGhpcy5fcmVnaXN0ZXJNYWluUmVmKGVsKTtcbiAgICB9IGVsc2UgaWYgKGVsLnR5cGUgPT09ICdzaWRlJykge1xuICAgICAgdGhpcy5fcmVnaXN0ZXJTaWRlUmVmKGVsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgRXJyb3IoJ1VucmVjb2duaXplZCByZXNpemUgZWxlbWVudCB0eXBlJylcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0SW5pdGlhbFdpZHRoKHR5cGU6ICdtYWluJyB8ICdzaWRlJyk6IG51bWJlciB7XG4gICAgaWYgKHR5cGUgPT09ICdtYWluJykge1xuICAgICAgcmV0dXJuIHRoaXMubWFpbkNvbmZpZy5pbml0aWFsO1xuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3NpZGUnKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaWRlQ29uZmlnLmluaXRpYWw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB2b2lkIDA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldE1pbldpZHRoKHR5cGU6ICdtYWluJyB8ICdzaWRlJyk6IG51bWJlciB7XG4gICAgaWYgKHR5cGUgPT09ICdtYWluJykge1xuICAgICAgcmV0dXJuIHRoaXMubWFpbkNvbmZpZy5taW47XG4gICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2lkZScpIHtcbiAgICAgIHJldHVybiB0aGlzLnNpZGVDb25maWcubWluO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNYXhXaWR0aCh0eXBlOiAnbWFpbicgfCAnc2lkZScpOiBudW1iZXIge1xuICAgIGlmICh0eXBlID09PSAnbWFpbicpIHtcbiAgICAgIHJldHVybiB0aGlzLm1haW5Db25maWcubWF4O1xuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3NpZGUnKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaWRlQ29uZmlnLm1heDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHdpZHRoIGZyb20gb3V0c2lkZSB3aXRoIGFsbCBjYWxjdWxhdGlvbnMgdG8gYmUgZG9uZVxuICAgKiBAcGFyYW0gd2lkdGhcbiAgICovXG4gIHB1YmxpYyB1cGRhdGVNYWluV2lkdGgod2lkdGg6IG51bWJlcikge1xuICAgIGNvbnN0IHNpZGVXaWR0aCA9ICh0aGlzLnNpZGVFbFJlZiAmJiB0aGlzLnNpZGVFbFJlZi53aWR0aCkgfHwgMDtcbiAgICB0aGlzLm1haW5FbFJlZi51cGRhdGVXaWR0aChzaWRlV2lkdGggKyB3aWR0aCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHdpZHRoIGZyb20gb3V0c2lkZSB3aXRoIGFsbCBjYWxjdWxhdGlvbnMgdG8gYmUgZG9uZVxuICAgKiBAcGFyYW0gd2lkdGhcbiAgICovXG4gIHB1YmxpYyB1cGRhdGVTaWRlV2lkdGgod2lkdGg6IG51bWJlcikge1xuICAgIGlmICh0aGlzLnNpZGVFbFJlZikge1xuICAgICAgY29uc3QgY3VycmVudFdpZHRoID0gdGhpcy5tYWluRWxSZWYud2lkdGggLSB0aGlzLnNpZGVFbFJlZi53aWR0aDtcbiAgICAgIHRoaXMubWFpbkVsUmVmLnVwZGF0ZVdpZHRoKGN1cnJlbnRXaWR0aCArIHdpZHRoKTtcbiAgICAgIHRoaXMuc2lkZUVsUmVmLnVwZGF0ZVdpZHRoKHdpZHRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUHVzaCBjdXJyZW50IGRyYXdlciB0byBiZSB2aXNpYmxlIHVuZGVyIG5ldyBvbmUgb3BlbmVkXG4gICAqIEBwYXJhbSBpbkZyb250RHJhd2VyXG4gICAqL1xuICBwdWJsaWMgcHVzaE1haW5XaWR0aChpbkZyb250RHJhd2VyOiBEcmF3ZXJSZWY8YW55Pikge1xuICAgIGNvbnN0IGluRnJvbnREcmF3ZXJUb3RhbFdpZHRoID0gaW5Gcm9udERyYXdlci5yZXNpemVDb250cm9sbGVyLm1haW5FbFJlZi53aWR0aCArIE1BSU5fUkVTSVpFX0FDVElPTl9CQVJfV0lEVEg7XG5cbiAgICBpZiAodGhpcy5tYWluRWxSZWYud2lkdGggPD0gaW5Gcm9udERyYXdlclRvdGFsV2lkdGgpIHtcbiAgICAgIHRoaXMudXBkYXRlTWFpbldpZHRoKGluRnJvbnREcmF3ZXJUb3RhbFdpZHRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlzdGVuIGZvciBicm93c2VyIHJlc2l6ZSBhbmQgdXBkYXRlIHJlc3RyaWN0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBfbGlzdGVuV2luZG93UmVzaXplKCkge1xuICAgIHRoaXMuX25nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBmcm9tRXZlbnQod2luZG93LCAncmVzaXplJylcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgZGVib3VuY2VUaW1lKDUwKSxcbiAgICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjcmVlbldpZHRoKCk7XG4gICAgICAgICAgdGhpcy5fdXBkYXRlTWluTWF4U3R5bGVzKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvcHkgaW5pdGlhbCBjb25maWdzIG9yIHNldCBkZWZhdWx0IHZhbHVlc1xuICAgKi9cbiAgcHJpdmF0ZSBfaW5pdERlZmF1bHRDb25maWdzKCkge1xuICAgIHRoaXMuX21haW5Db25maWcgPVxuICAgICAgKHRoaXMuX2RyYXdlclJlZi5kcmF3ZXJDb25maWcud2lkdGggJiYgdGhpcy5fZHJhd2VyUmVmLmRyYXdlckNvbmZpZy53aWR0aC5tYWluKVxuICAgICAgfHwge307XG5cbiAgICB0aGlzLl9tYWluQ29uZmlnLmluaXRpYWwgPSB0aGlzLl9tYWluQ29uZmlnLmluaXRpYWwgfHwgTUFJTl9EUkFXRVJfREVGQVVMVF9XSURUSDtcblxuICAgIHRoaXMuX3NpZGVDb25maWcgPVxuICAgICAgKHRoaXMuX2RyYXdlclJlZi5kcmF3ZXJDb25maWcud2lkdGggJiYgdGhpcy5fZHJhd2VyUmVmLmRyYXdlckNvbmZpZy53aWR0aC5zaWRlKVxuICAgICAgfHwge307XG5cbiAgICB0aGlzLl9zaWRlQ29uZmlnLmluaXRpYWwgPSB0aGlzLl9zaWRlQ29uZmlnLmluaXRpYWwgfHwgU0lERV9EUkFXRVJfREVGQVVMVF9XSURUSDtcbiAgfVxuXG4gIHByaXZhdGUgX3JlZ2lzdGVyTWFpblJlZihlbDogRnNEcmF3ZXJSZXNpemVyRGlyZWN0aXZlKSB7XG4gICAgdGhpcy5fbWFpbkVsUmVmID0gZWw7XG4gIH1cblxuICBwcml2YXRlIF9yZWdpc3RlclNpZGVSZWYoZWw6IEZzRHJhd2VyUmVzaXplckRpcmVjdGl2ZSkge1xuICAgIHRoaXMuX3NpZGVFbFJlZiA9IGVsO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBjdXJyZW50IHdpbmRvdyBzaXplXG4gICAqL1xuICBwcml2YXRlIF91cGRhdGVTY3JlZW5XaWR0aCgpOiB2b2lkIHtcbiAgICB0aGlzLl9zY3JlZW5XaWR0aCA9ICh3aW5kb3cuaW5uZXJXaWR0aCAtIHRoaXMuX2JvcmRlclBhZGRpbmcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBtaW4mbWF4IGNzcyBwcm9wcyBmb3IgY29udGFpbmVyc1xuICAgKi9cbiAgcHJpdmF0ZSBfdXBkYXRlTWluTWF4U3R5bGVzKCk6IHZvaWQge1xuICAgIHRoaXMubWFpbkVsUmVmLnNldE1pbk1heFN0eWxlcygpO1xuXG4gICAgaWYgKHRoaXMuc2lkZUVsUmVmKSB7XG4gICAgICB0aGlzLnNpZGVFbFJlZi5zZXRNaW5NYXhTdHlsZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9saXN0ZW5TaWRlVG9nZ2xlKCk6IHZvaWQge1xuICAgIHRoaXMuX2RyYXdlclJlZi5zaWRlVG9nZ2xlJFxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChvcGVuZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX3NpZGVPcGVuZWQgPT09IG9wZW5lZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3NpZGVPcGVuZWQgPSBvcGVuZWQ7XG5cbiAgICAgICAgaWYgKG9wZW5lZCkge1xuICAgICAgICAgIGNvbnN0IGN1cnJlbnRXaWR0aCA9IHRoaXMubWFpbkVsUmVmLndpZHRoO1xuICAgICAgICAgIGNvbnN0IHNpZGVXaWR0aCA9IHRoaXMuZ2V0SW5pdGlhbFdpZHRoKCdzaWRlJyk7XG5cbiAgICAgICAgICB0aGlzLl9tYWluRWxSZWYudXBkYXRlV2lkdGgoY3VycmVudFdpZHRoICsgc2lkZVdpZHRoICsgU0lERV9SRVNJWkVfQkFSX1dJRFRIKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBhY3R1YWxTaWRlV2lkdGggPSB0aGlzLnNpZGVFbFJlZi5mc0RyYXdlclJlc2l6ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XG4gICAgICAgICAgY29uc3QgbWFpbldpZHRoID0gdGhpcy5tYWluRWxSZWYud2lkdGggLSBhY3R1YWxTaWRlV2lkdGggLSBTSURFX1JFU0laRV9CQVJfV0lEVEg7XG5cbiAgICAgICAgICB0aGlzLl9tYWluRWxSZWYudXBkYXRlV2lkdGgobWFpbldpZHRoKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgfVxufVxuIl19