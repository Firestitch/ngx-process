import { __decorate, __metadata } from "tslib";
import { Directive, ElementRef, Input, NgZone, OnDestroy, OnInit, Renderer2, } from '@angular/core';
import { Subject } from 'rxjs';
import { DrawerSizeController } from '../classes/drawer-size-controller';
let FsDrawerResizerDirective = class FsDrawerResizerDirective {
    constructor(_el, _renderer, _ngZone) {
        this._el = _el;
        this._renderer = _renderer;
        this._ngZone = _ngZone;
        this.fsDrawerResizer = this._el.nativeElement;
        this.direction = 'left';
        this.resizable = true;
        this._dragStartHandler = this._dragStart.bind(this);
        this._dragHandler = this._drag.bind(this);
        this._dragEndHandler = this._dragEnd.bind(this);
        this._x = 0;
        this._width = 0;
        this._actionsWidth = 0;
        this._destroy$ = new Subject();
    }
    get width() {
        return this._width;
    }
    get minWidth() {
        const minWidth = this.sizeController.getMinWidth(this.type);
        if (minWidth && minWidth >= 0) {
            if (minWidth > this.sizeController.screenWidth) {
                return this.sizeController.screenWidth;
            }
            else {
                return minWidth;
            }
        }
    }
    get maxWidth() {
        const maxWidth = this.sizeController.getMaxWidth(this.type);
        let parentContainerWidth = null;
        if (this.parentContainer) {
            parentContainerWidth = this._getElementWidth(this.parentContainer.nativeElement);
        }
        if (parentContainerWidth !== null) {
            return !maxWidth || maxWidth >= parentContainerWidth
                ? parentContainerWidth - this._actionsWidth * 2
                : maxWidth;
        }
        else {
            return !maxWidth || maxWidth >= this.sizeController.screenWidth
                ? this.sizeController.screenWidth
                : maxWidth;
        }
    }
    ngOnInit() {
        this.sizeController.registerElRef(this);
        if (this.resizable) {
            this._ngZone.runOutsideAngular(() => {
                this._el.nativeElement.addEventListener('mousedown', this._dragStartHandler, false);
                this._el.nativeElement.addEventListener('touchstart', this._dragStartHandler, false);
            });
            if (this.actionsContainer) {
                this._actionsWidth = this._getElementWidth(this.actionsContainer.nativeElement);
            }
            this.setMinMaxStyles();
            const minWidth = this.sizeController.getMinWidth(this.type);
            let width = this.sizeController.getInitialWidth(this.type)
                || this._getElementWidth(this.fsDrawerResizer);
            if (width < minWidth) {
                width = minWidth;
            }
            this.updateWidth(width);
        }
    }
    updateWidth(width) {
        this._width = width;
        requestAnimationFrame(() => {
            this._renderer.setStyle(this.fsDrawerResizer, 'width', `${width}px`);
        });
    }
    ngOnDestroy() {
        this._el.nativeElement.removeEventListener('mousedown', this._dragStartHandler, false);
        this._el.nativeElement.removeEventListener('touchstart', this._dragStartHandler, false);
        this._destroy$.next();
        this._destroy$.complete();
    }
    /**
     * Set inline styles min/max width
     */
    setMinMaxStyles() {
        requestAnimationFrame(() => {
            this._renderer.setStyle(this.fsDrawerResizer, 'min-width', `${this.minWidth}px`);
            this._renderer.setStyle(this.fsDrawerResizer, 'max-width', `${this.maxWidth}px`);
        });
    }
    /**
     * Subscribe to move events and init base dimensions/restrictions
     * @param event { MouseEvent }
     */
    _dragStart(event) {
        this._x = this._getClientX(event);
        this._width = this._getElementWidth(this.fsDrawerResizer);
        this.setMinMaxStyles();
        document.addEventListener('touchmove', this._dragHandler, false);
        document.addEventListener('touchend', this._dragEndHandler, false);
        document.addEventListener('mousemove', this._dragHandler, false);
        document.addEventListener('mouseup', this._dragEndHandler, false);
    }
    /**
     * Update coordinates during drag
     * @param event
     */
    _drag(event) {
        const clientX = this._getClientX(event);
        const predictedWidth = this._calcWidth(this.direction, clientX);
        this._updatePosition(clientX, predictedWidth);
        this._emitResizeEvent();
    }
    /**
     * Remove listeners when drag finished
     * @param event
     */
    _dragEnd(event) {
        document.removeEventListener('mousemove', this._dragHandler, false);
        document.removeEventListener('mouseup', this._dragEndHandler, false);
        document.removeEventListener('touchmove', this._dragHandler, false);
        document.removeEventListener('touchend', this._dragEndHandler, false);
    }
    /**
     *
     * @param event
     */
    _getClientX(event) {
        return event.touches ? event.touches[0].clientX : event.clientX;
    }
    /**
     * Will return width of element
     * @param el
     */
    _getElementWidth(el) {
        return el.getBoundingClientRect().width;
    }
    /**
     * Update width and position of target element
     * @param clientX
     * @param width
     */
    _updatePosition(clientX, width) {
        this._x = clientX;
        this.updateWidth(width < 0 ? 0 : width);
    }
    /**
     * Calc new width based on offset from previous position
     * @param direction
     * @param clientX
     */
    _calcWidth(direction, clientX) {
        const directionSign = direction === 'left' ? -1 : 1;
        return this._width + (this._x - clientX) * directionSign;
    }
    /**
     * Resize event for Window
     */
    _emitResizeEvent() {
        const resizeEvent = window.document.createEvent('UIEvents');
        resizeEvent.initEvent('resize', true, false);
        window.dispatchEvent(resizeEvent);
    }
};
FsDrawerResizerDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: NgZone }
];
__decorate([
    Input(),
    __metadata("design:type", Object)
], FsDrawerResizerDirective.prototype, "fsDrawerResizer", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], FsDrawerResizerDirective.prototype, "type", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], FsDrawerResizerDirective.prototype, "direction", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], FsDrawerResizerDirective.prototype, "resizable", void 0);
__decorate([
    Input(),
    __metadata("design:type", ElementRef)
], FsDrawerResizerDirective.prototype, "parentContainer", void 0);
__decorate([
    Input(),
    __metadata("design:type", ElementRef)
], FsDrawerResizerDirective.prototype, "actionsContainer", void 0);
__decorate([
    Input(),
    __metadata("design:type", DrawerSizeController)
], FsDrawerResizerDirective.prototype, "sizeController", void 0);
FsDrawerResizerDirective = __decorate([
    Directive({
        selector: '[fsDrawerResizer]',
        host: {
            '[style.cursor]': '"col-resize"',
        }
    }),
    __metadata("design:paramtypes", [ElementRef,
        Renderer2,
        NgZone])
], FsDrawerResizerDirective);
export { FsDrawerResizerDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhd2VyLXJlc2l6ZXIuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZpcmVzdGl0Y2gvZHJhd2VyLyIsInNvdXJjZXMiOlsiYXBwL2RpcmVjdGl2ZXMvZHJhd2VyLXJlc2l6ZXIuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxNQUFNLEVBQ04sU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFTekUsSUFBYSx3QkFBd0IsR0FBckMsTUFBYSx3QkFBd0I7SUFvQm5DLFlBQ1UsR0FBZSxFQUNmLFNBQW9CLEVBQ3BCLE9BQWU7UUFGZixRQUFHLEdBQUgsR0FBRyxDQUFZO1FBQ2YsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBckJULG9CQUFlLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7UUFFekMsY0FBUyxHQUFHLE1BQU0sQ0FBQztRQUNuQixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBS3pCLHNCQUFpQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9DLGlCQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsb0JBQWUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUzQyxPQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ1AsV0FBTSxHQUFHLENBQUMsQ0FBQztRQUNYLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBRWxCLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFB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QU07O0FBckJoQjtJQUFSLEtBQUssRUFBRTs7aUVBQWlEO0FBQ2hEO0lBQVIsS0FBSyxFQUFFOztzREFBOEI7QUFDN0I7SUFBUixLQUFLLEVBQUU7OzJEQUEyQjtBQUMxQjtJQUFSLEtBQUssRUFBRTs7MkRBQXlCO0FBQ3hCO0lBQVIsS0FBSyxFQUFFOzhCQUF5QixVQUFVO2lFQUFDO0FBQ25DO0lBQVIsS0FBSyxFQUFFOzhCQUEwQixVQUFVO2tFQUFDO0FBQ3BDO0lBQVIsS0FBSyxFQUFFOzhCQUF3QixvQkFBb0I7Z0VBQUM7QUFSMUMsd0JBQXdCO0lBTnBDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxtQkFBbUI7UUFDN0IsSUFBSSxFQUFFO1lBQ0osZ0JBQWdCLEVBQUUsY0FBYztTQUNqQztLQUNGLENBQUM7cUNBc0JlLFVBQVU7UUFDSixTQUFTO1FBQ1gsTUFBTTtHQXZCZCx3QkFBd0IsQ0EyTXBDO1NBM01ZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIE5nWm9uZSxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIFJlbmRlcmVyMixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IERyYXdlclNpemVDb250cm9sbGVyIH0gZnJvbSAnLi4vY2xhc3Nlcy9kcmF3ZXItc2l6ZS1jb250cm9sbGVyJztcblxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbZnNEcmF3ZXJSZXNpemVyXScsXG4gIGhvc3Q6IHtcbiAgICAnW3N0eWxlLmN1cnNvcl0nOiAnXCJjb2wtcmVzaXplXCInLFxuICB9XG59KVxuZXhwb3J0IGNsYXNzIEZzRHJhd2VyUmVzaXplckRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICBASW5wdXQoKSBwdWJsaWMgZnNEcmF3ZXJSZXNpemVyID0gdGhpcy5fZWwubmF0aXZlRWxlbWVudDtcbiAgQElucHV0KCkgcHVibGljIHR5cGU6ICdtYWluJyB8ICdzaWRlJztcbiAgQElucHV0KCkgcHVibGljIGRpcmVjdGlvbiA9ICdsZWZ0JztcbiAgQElucHV0KCkgcHVibGljIHJlc2l6YWJsZSA9IHRydWU7XG4gIEBJbnB1dCgpIHB1YmxpYyBwYXJlbnRDb250YWluZXI6IEVsZW1lbnRSZWY7XG4gIEBJbnB1dCgpIHB1YmxpYyBhY3Rpb25zQ29udGFpbmVyOiBFbGVtZW50UmVmO1xuICBASW5wdXQoKSBwdWJsaWMgc2l6ZUNvbnRyb2xsZXI6IERyYXdlclNpemVDb250cm9sbGVyO1xuXG4gIHByaXZhdGUgX2RyYWdTdGFydEhhbmRsZXIgPSB0aGlzLl9kcmFnU3RhcnQuYmluZCh0aGlzKTtcbiAgcHJpdmF0ZSBfZHJhZ0hhbmRsZXIgPSB0aGlzLl9kcmFnLmJpbmQodGhpcyk7XG4gIHByaXZhdGUgX2RyYWdFbmRIYW5kbGVyID0gdGhpcy5fZHJhZ0VuZC5iaW5kKHRoaXMpO1xuXG4gIHByaXZhdGUgX3ggPSAwO1xuICBwcml2YXRlIF93aWR0aCA9IDA7XG4gIHByaXZhdGUgX2FjdGlvbnNXaWR0aCA9IDA7XG5cbiAgcHJpdmF0ZSBfZGVzdHJveSQgPSBuZXcgU3ViamVjdCgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX2VsOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSBfbmdab25lOiBOZ1pvbmUsXG4gICkge31cblxuICBwdWJsaWMgZ2V0IHdpZHRoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3dpZHRoO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgbWluV2lkdGgoKTogbnVtYmVyIHtcbiAgICBjb25zdCBtaW5XaWR0aCA9IHRoaXMuc2l6ZUNvbnRyb2xsZXIuZ2V0TWluV2lkdGgodGhpcy50eXBlKTtcblxuICAgIGlmIChtaW5XaWR0aCAmJiBtaW5XaWR0aCA+PSAwKSB7XG4gICAgICBpZiAobWluV2lkdGggPiB0aGlzLnNpemVDb250cm9sbGVyLnNjcmVlbldpZHRoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNpemVDb250cm9sbGVyLnNjcmVlbldpZHRoO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG1pbldpZHRoO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0IG1heFdpZHRoKCk6IG51bWJlciB7XG4gICAgY29uc3QgbWF4V2lkdGggPSB0aGlzLnNpemVDb250cm9sbGVyLmdldE1heFdpZHRoKHRoaXMudHlwZSk7XG4gICAgbGV0IHBhcmVudENvbnRhaW5lcldpZHRoID0gbnVsbDtcblxuICAgIGlmICh0aGlzLnBhcmVudENvbnRhaW5lcikge1xuICAgICAgcGFyZW50Q29udGFpbmVyV2lkdGggPSB0aGlzLl9nZXRFbGVtZW50V2lkdGgodGhpcy5wYXJlbnRDb250YWluZXIubmF0aXZlRWxlbWVudCk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmVudENvbnRhaW5lcldpZHRoICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gIW1heFdpZHRoIHx8IG1heFdpZHRoID49IHBhcmVudENvbnRhaW5lcldpZHRoXG4gICAgICAgID8gcGFyZW50Q29udGFpbmVyV2lkdGggLSB0aGlzLl9hY3Rpb25zV2lkdGggKiAyXG4gICAgICAgIDogbWF4V2lkdGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAhbWF4V2lkdGggfHwgbWF4V2lkdGggPj0gdGhpcy5zaXplQ29udHJvbGxlci5zY3JlZW5XaWR0aFxuICAgICAgICA/IHRoaXMuc2l6ZUNvbnRyb2xsZXIuc2NyZWVuV2lkdGhcbiAgICAgICAgOiBtYXhXaWR0aDtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbmdPbkluaXQoKSB7XG5cbiAgICB0aGlzLnNpemVDb250cm9sbGVyLnJlZ2lzdGVyRWxSZWYodGhpcyk7XG5cbiAgICBpZiAodGhpcy5yZXNpemFibGUpIHtcbiAgICAgIHRoaXMuX25nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fZHJhZ1N0YXJ0SGFuZGxlciwgZmFsc2UpO1xuICAgICAgICB0aGlzLl9lbC5uYXRpdmVFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLl9kcmFnU3RhcnRIYW5kbGVyLCBmYWxzZSk7XG4gICAgICB9KTtcblxuICAgICAgaWYgKHRoaXMuYWN0aW9uc0NvbnRhaW5lcikge1xuICAgICAgICB0aGlzLl9hY3Rpb25zV2lkdGggPSB0aGlzLl9nZXRFbGVtZW50V2lkdGgodGhpcy5hY3Rpb25zQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2V0TWluTWF4U3R5bGVzKCk7XG5cbiAgICAgIGNvbnN0IG1pbldpZHRoID0gdGhpcy5zaXplQ29udHJvbGxlci5nZXRNaW5XaWR0aCh0aGlzLnR5cGUpO1xuICAgICAgbGV0IHdpZHRoID0gdGhpcy5zaXplQ29udHJvbGxlci5nZXRJbml0aWFsV2lkdGgodGhpcy50eXBlKVxuICAgICAgICB8fCB0aGlzLl9nZXRFbGVtZW50V2lkdGgodGhpcy5mc0RyYXdlclJlc2l6ZXIpO1xuXG4gICAgICBpZiAod2lkdGggPCBtaW5XaWR0aCkge1xuICAgICAgICB3aWR0aCA9IG1pbldpZHRoO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnVwZGF0ZVdpZHRoKHdpZHRoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlV2lkdGgod2lkdGgpIHtcbiAgICB0aGlzLl93aWR0aCA9IHdpZHRoO1xuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKHRoaXMuZnNEcmF3ZXJSZXNpemVyLCAnd2lkdGgnLCBgJHt3aWR0aH1weGApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fZHJhZ1N0YXJ0SGFuZGxlciwgZmFsc2UpO1xuICAgIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHRoaXMuX2RyYWdTdGFydEhhbmRsZXIsIGZhbHNlKTtcblxuICAgIHRoaXMuX2Rlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBpbmxpbmUgc3R5bGVzIG1pbi9tYXggd2lkdGhcbiAgICovXG4gIHB1YmxpYyBzZXRNaW5NYXhTdHlsZXMoKSB7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKHRoaXMuZnNEcmF3ZXJSZXNpemVyLCAnbWluLXdpZHRoJywgYCR7dGhpcy5taW5XaWR0aH1weGApO1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U3R5bGUodGhpcy5mc0RyYXdlclJlc2l6ZXIsICdtYXgtd2lkdGgnLCBgJHt0aGlzLm1heFdpZHRofXB4YClcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpYmUgdG8gbW92ZSBldmVudHMgYW5kIGluaXQgYmFzZSBkaW1lbnNpb25zL3Jlc3RyaWN0aW9uc1xuICAgKiBAcGFyYW0gZXZlbnQgeyBNb3VzZUV2ZW50IH1cbiAgICovXG4gIHByaXZhdGUgX2RyYWdTdGFydChldmVudDogTW91c2VFdmVudCkge1xuXG4gICAgdGhpcy5feCA9IHRoaXMuX2dldENsaWVudFgoZXZlbnQpO1xuICAgIHRoaXMuX3dpZHRoID0gdGhpcy5fZ2V0RWxlbWVudFdpZHRoKHRoaXMuZnNEcmF3ZXJSZXNpemVyKTtcblxuICAgIHRoaXMuc2V0TWluTWF4U3R5bGVzKCk7XG5cbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9kcmFnSGFuZGxlciwgZmFsc2UpO1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5fZHJhZ0VuZEhhbmRsZXIsIGZhbHNlKTtcblxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX2RyYWdIYW5kbGVyLCBmYWxzZSk7XG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuX2RyYWdFbmRIYW5kbGVyLCBmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGNvb3JkaW5hdGVzIGR1cmluZyBkcmFnXG4gICAqIEBwYXJhbSBldmVudFxuICAgKi9cbiAgcHJpdmF0ZSBfZHJhZyhldmVudDogTW91c2VFdmVudCkge1xuICAgIGNvbnN0IGNsaWVudFggPSB0aGlzLl9nZXRDbGllbnRYKGV2ZW50KTtcblxuICAgIGNvbnN0IHByZWRpY3RlZFdpZHRoID0gdGhpcy5fY2FsY1dpZHRoKHRoaXMuZGlyZWN0aW9uLCBjbGllbnRYKTtcblxuICAgIHRoaXMuX3VwZGF0ZVBvc2l0aW9uKGNsaWVudFgsIHByZWRpY3RlZFdpZHRoKTtcbiAgICB0aGlzLl9lbWl0UmVzaXplRXZlbnQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgbGlzdGVuZXJzIHdoZW4gZHJhZyBmaW5pc2hlZFxuICAgKiBAcGFyYW0gZXZlbnRcbiAgICovXG4gIHByaXZhdGUgX2RyYWdFbmQoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLl9kcmFnSGFuZGxlciwgZmFsc2UpO1xuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9kcmFnRW5kSGFuZGxlciwgZmFsc2UpO1xuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuX2RyYWdIYW5kbGVyLCBmYWxzZSk7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLl9kcmFnRW5kSGFuZGxlciwgZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSBldmVudFxuICAgKi9cbiAgcHJpdmF0ZSBfZ2V0Q2xpZW50WChldmVudCkge1xuICAgIHJldHVybiBldmVudC50b3VjaGVzID8gZXZlbnQudG91Y2hlc1swXS5jbGllbnRYIDogZXZlbnQuY2xpZW50WDtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaWxsIHJldHVybiB3aWR0aCBvZiBlbGVtZW50XG4gICAqIEBwYXJhbSBlbFxuICAgKi9cbiAgcHJpdmF0ZSBfZ2V0RWxlbWVudFdpZHRoKGVsKSB7XG4gICAgcmV0dXJuIGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB3aWR0aCBhbmQgcG9zaXRpb24gb2YgdGFyZ2V0IGVsZW1lbnRcbiAgICogQHBhcmFtIGNsaWVudFhcbiAgICogQHBhcmFtIHdpZHRoXG4gICAqL1xuICBwcml2YXRlIF91cGRhdGVQb3NpdGlvbihjbGllbnRYOiBudW1iZXIsIHdpZHRoOiBudW1iZXIpIHtcbiAgICB0aGlzLl94ID0gY2xpZW50WDtcbiAgICB0aGlzLnVwZGF0ZVdpZHRoKHdpZHRoIDwgMCA/IDAgOiB3aWR0aClcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjIG5ldyB3aWR0aCBiYXNlZCBvbiBvZmZzZXQgZnJvbSBwcmV2aW91cyBwb3NpdGlvblxuICAgKiBAcGFyYW0gZGlyZWN0aW9uXG4gICAqIEBwYXJhbSBjbGllbnRYXG4gICAqL1xuICBwcml2YXRlIF9jYWxjV2lkdGgoZGlyZWN0aW9uLCBjbGllbnRYKSB7XG4gICAgY29uc3QgZGlyZWN0aW9uU2lnbiA9IGRpcmVjdGlvbiA9PT0gJ2xlZnQnID8gLTEgOiAxO1xuXG4gICAgcmV0dXJuIHRoaXMuX3dpZHRoICsgKHRoaXMuX3ggLSBjbGllbnRYKSAqIGRpcmVjdGlvblNpZ247XG4gIH1cblxuICAvKipcbiAgICogUmVzaXplIGV2ZW50IGZvciBXaW5kb3dcbiAgICovXG4gIHByaXZhdGUgX2VtaXRSZXNpemVFdmVudCgpIHtcbiAgICBjb25zdCByZXNpemVFdmVudCA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFdmVudCgnVUlFdmVudHMnKTtcbiAgICByZXNpemVFdmVudC5pbml0RXZlbnQoJ3Jlc2l6ZScsIHRydWUsIGZhbHNlKTtcblxuICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KHJlc2l6ZUV2ZW50KTtcbiAgfVxufVxuIl19